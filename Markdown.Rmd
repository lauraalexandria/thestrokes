---
output: 
  html_document: 
    code_folding: "hide"
    df_print: default
    toc: yes
    toc_depth: 1
    toc_float:
      collapsed: no
---

```{css, echo=FALSE}
@import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Raleway:ital,wght@1,600&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Open+Sans&display=swap');


body {
  text-align: justify;
  font-family: 'Open Sans', sans-serif;
}

.title {
  color: #A92323;
  font-size: 10px; 
  font-family: 'Montserrat', sans-serif;
  text-align: right;
  position: fixed;
  top: 5%;
  right: 74%;
  width: 300px;
}

.date {
  color: #dedede;
  font-size: 20px;
  font-family: 'Raleway', sans-serif;
  text-align: right;
  position: fixed;
  top: 27%;
  right: 74%;
  width: 250px;
}

#TOC {
  background: url("https://vandal-us.s3.amazonaws.com/spree/products/38559/original/uploads_2F1542892606452-ri8xswrviim-024e6ecc4b1cc21eded6b5f393e95096_2FStrokes-Vandal.jpg");
  background-size: contain;
  padding-top: 250px !important;
  background-repeat: no-repeat;
  color: #595260;
  font-family: 'Poppins', sans-serif;
  border-color: #ffffff
}
  
.tocify {
  border: none;
}
  
.list-group-item.active, .list-group-item.active:focus, .list-group-item.active:hover {
    background-color: #595260 /*Cor do background da TOC quando selecionada*/
}  

div.meunome {
 text-align: justify;
 position: fixed;
 top: 88%;
 right: 77%;
}
 
.section h1 {
  color: #548CA8;
	font-family: 'Montserrat', sans-serif;
	border-bottom: 1px solid #dedede
}
  
.section h2 {
  color: #B2B1B9;
  font-family: 'Poppins', sans-serif;  
}
  
b, strong {
  color: #548CA8;
}

mark {
  background-color: #FFBBA4;
}

a {
  color: #778bd9;
}

div.bloco {
  text-align: justify;
  padding: 1em;
  background: #f5eeeb;
  color: black;
  border: 5px solid white;
  border-radius: 10px;
}

div.metade {
  width: 50%;
  float: left;
  text-align: justify;
  padding: 1em;
  background: #f5eeeb;
  color: black;
  border: 5px solid white;
  border-radius: 10px;
}

div.meunome {
 text-align: justify;
 position: fixed;
 top: 75%;
 right: 77%;
}

ul.redes {
  position: fixed;
  top: 92%;
  right: 82%;
}

ul.redes li{
  list-style: none;
  float: left;
  size: 30px;
  margin-right: 7px;
}

ul.redes a{
  color: #dedede;
  size: 30px;
}

ul.redes a:hover{
  color: #595260;
  text-decoration: none;
}

.nav-pills > li > a {
    color: #595260;
}

.nav-pills > li.active > a, 
.nav-pills > li.active > a:hover, 
.nav-pills > li.active > a:focus {
    color: white;
    background-color: #595260;
    }

```



```{r message=F, warning=F}
library(tidyverse)
library(tidytext)
library(wordcloud2)
library(textdata) 
library(here)
library(echarts4r)
library(word2vec)
library(crosstalk)
library(DT)
library(plotly)
library(factoextra)

data("stop_words")  # Fixando as stopwords
stop_words <- stop_words %>% add_row(word = c("yeah", "gonna", "hey"))

source("WebScraping.R")
source("DadosSpotify.R")

letras <- apply(songs[,3], 1, get_lyric)

songs <- songs %>% 
  mutate(letras = tolower(letras)) %>% 
  filter(!str_detect(SName, "ep Version|early")) %>% # Evitar nomes repetidos;
  mutate(SName = case_when(                          # Corrigindo nomes;
     SName == "Mercy, Mercy Me" ~ "Mercy Mercy Me (The Ecology)",
     SName == 'Hawaii Aloha' ~ 'Hawaii',
     SName == "Why Are Sunday's So Depressing" ~ "Why Are Sundays So Depressing",
     SName == "Oblivious" ~ "Oblivius",
     T ~ SName),
    SName = str_to_title(SName)) %>% 
  left_join(dados_spotify, by = c("SName" = "track_name")) %>% 
  mutate(album_name = case_when(
     is.na(album_name) ~ "Others",
     album_name == "Juicebox" ~ "Others",
     album_name == "Heart In A Cage" ~ "Others",
     album_name == "You Only Live Once/Mercy Mercy Me" ~ "Others",
     T ~ album_name))


e_common(theme = "london")
#opções de tema: london, tech-blue
```


# Introduction

In 2020, I discover [The New Abnormal](https://www.youtube.com/playlist?list=PLlLGTTlLJXAX-UwWbyH8m6SGSWRntdCf0) album and I started to be obsessed with The Strokes, beyond listen to the album over and over, I also noticed their previous work and loved as well. When I decided to practice on a project with webscraping and sentiment analysis, it seemed the perfect opportunity to use the songs i love so much and maybe understand some pattern from them. So here we go!

I collect the data from Spotify and Vagalume (a website that shares songs lyrics and their translations into Portuguese), so I had access to the lyrics and some numerical features that Spotify creates to measure some features of the songs, and also other information, like which of the albums the pieces are from. In case of curiosity, I add buttons that allow to see the codes I used. Any suggests are welcome!

Some of the references I used are:

* https://www.tidytextmining.com/tidytext.html
* https://m-clark.github.io/text-analysis-with-R/
* https://cbail.github.io/textasdata/word2vec/rmarkdown/word2vec.html
* http://csinpi.github.io/pubs/mml12_moore.pdf
* https://rpubs.com/nabiilahardini/word2vec
* https://github.com/bnosac/ruimtehol
* https://cran.r-project.org/web/packages/ruimtehol/vignettes/ground-control-to-ruimtehol.pdf
* https://michaelmccarthy.netlify.app/post/embedding-multimedia-files-in-r-markdown-html-documents/
* http://www.bnosac.be/index.php/blog/100-word2vec-in-R
* https://help.displayr.com/hc/en-us/articles/360003127476-How-to-Create-Customized-Tables-Using-the-DT-R-Package


# Word Clouds

The first analysis is a Word Cloud, here we used all lyrics, but I excluded the stopwords and no further transformation were made, like, it is possible to see the words friend and friends below. The bigger the word, more frequent it is in The Strokes discography. Here we can see a huge focus on the words ```time``` and ```wanna```. (Well, it seems to me that [Under Control](https://www.youtube.com/watch?v=4895ajU27b0) contributed a lot for this result).

<!-- (eu podia fazer esse stemming ai) -->

```{r message=F, warning=F}
contagem <- songs %>% select(c(2,4)) %>%
  unnest_tokens(word, letras) %>%
  anti_join(stop_words) %>%
  count(word)

#wordcloud2(contagem %>% filter(n > 5))

contagem %>%
  filter(n > 5) %>%
  e_charts() %>%
  e_cloud(word, n, shape = "circle") %>% 
  e_tooltip(backgroundColor = "rgb(255,255,255,0.8)", 
            borderColor = '#333', borderWidth = 1,
            textStyle = list(color = '#333'))

```


# Number of words by Song

Next, the question was the number of words in each song, a histogram was created to analyze this attribute and it is possible to see that the majority of the songs have between 150 to 250 words, here the stop words were kept on the data. Beyond that, the released song with least words was [Metabolism](https://www.youtube.com/watch?v=5YEHqiyb7AE) with about 3 minutes and 70 words and the song with the biggest amount of words is [Eternal Summer](https://www.youtube.com/watch?v=5c3EjeP2x-Q) which has about 6 minutes long and we can listen to 395 words.


```{r message=FALSE, warning=FALSE}
num_por_song <- songs %>% 
  select(c("SName", "letras", "album_name")) %>% 
  unnest_tokens(word, letras) %>%
  # anti_join(stop_words) %>%
  group_by(SName, album_name) %>% 
  count() %>% ungroup()

num_por_song  %>% 
  #group_by(album_name) %>% 
  e_charts() %>%
  e_histogram(n) %>% 
  e_tooltip(trigger = "axis", backgroundColor = "rgb(255,255,255,0.8)", 
            borderColor = '#333', borderWidth = 1,
            textStyle = list(color = '#333'))
```

```{r message=FALSE, warning=FALSE}
menor <- num_por_song %>% slice_min(order_by = n, n = 1)
menor_mus <- menor %>% pull(SName)
menor_quant <- menor %>% pull(n)
maior <- num_por_song %>% slice_max(order_by = n, n = 1)
maior_mus <- maior %>% pull(SName)
maior_quant <- maior %>% pull(n)
```

  
<div class = "metade">
### `r menor_mus`

#### `r menor_quant` min
</div>
  
<div class = "metade">
### `r maior_mus`

#### `r maior_quant` min
</div>


# Sentiment Analysis

Other possible analysis is the Sentiment Analysis, here I used the NRC technique, each word receive a label with a sentiment, there are 10 possibilities: Anger, Anticipation, Disgust, Fear, Joy, Negative, Positive, Sadness, Surprise and Trust. Unfortunately, this analysis doesn't capture the context of the words, a aspect that changes the whole meaning, but let's go! 

In the first plot is possible to see the frequency of all sentiments beyond all songs, the Negative sentiment is the most frequent and then we have the Positive sentiment, so it's hard to conclude further than this. In the next part we can compare the sentiments in the songs in each album.

```{r message=FALSE, warning=FALSE}
sentiments <- get_sentiments("nrc")

songs_e_sent <- songs %>% select(c(2, 4, 5)) %>% 
  unnest_tokens(word, letras) %>%
  anti_join(stop_words) %>% inner_join(sentiments) %>% 
  mutate(sentiment = str_to_sentence(sentiment))

songs_e_sent %>% 
  group_by(sentiment) %>% 
  count() %>% ungroup() %>% 
  arrange(n) %>% 
  e_charts(sentiment) %>% 
  e_bar(n, name = "Frequency", legend = F) %>% 
  e_flip_coords() %>% 
  e_tooltip(backgroundColor = "rgba(255,255,255,0.8)", borderColor = '#333', borderWidth = 1,
            textStyle = list(color = '#333')) %>% 
  e_labels(position = "right")
```


```{r message = F}
sent_por_mus <- songs_e_sent %>% 
  group_by(SName, album_name, sentiment) %>% count() %>% 
  ungroup() %>% group_by(SName) %>% 
  mutate(prop = round(n/sum(n), 3)) %>% 
  ungroup()
```


## {.tabset .tabset-fade .tabset-pills}

```{r message = F}
# prop_sent_by_song <- function(input_album){
#   
#   df <- songs_e_albuns %>% 
#   filter(Album == input_album) %>% 
#   group_by(SName, sentiment) %>% count() %>% 
#   ungroup() %>% group_by(SName) %>% 
#   mutate(prop = round(n/sum(n), 2)) %>% 
#     ungroup()
#   
#   principal_sentimento <- df %>% 
#     filter(prop == max(prop)) %>% 
#     pull(sentiment)
#   
#   df %>% group_by(SName) %>% 
#   e_charts(sentiment, timeline = TRUE) %>% 
#   e_pie(prop, legend = F, radius = c("45%", "70%")) %>% 
#   #e_grid(left = "30%")  %>% 
#   e_timeline_opts(
#         top = 'middle',
#         right = '100%',
#         orient = "vertical",
#         label = list(position = 'left'),
#         controlStyle = list(showPlayBtn = F, itemSize = 0, itemGap = 110),
#         lineStyle = list(show = F),
#         itemStyle = list(color = 'rgba(128, 128, 128, 0.3)')
#     ) %>%
#   e_tooltip("item", 
#             backgroundColor = "rgba(255,255,255,0.8)", 
#             borderColor = '#333', borderWidth = 1,
#             textStyle = list(color = '#333')) %>% 
#     e_text_g(right = 385, top = 250, z = -999,
#              style = list(text = principal_sentimento, 
#                           width = 450, opacity = .6)
#              ) 
#   
# }

prop_sent_by_song <- function(input_album){
  
  ordem_sent <- c("Positive", "Joy", "Trust", "Surprise", "Anticipation",
                  "Disgust", "Fear", "Anger", "Sadness", "Negative")
  
  df <- sent_por_mus %>% 
    mutate(sentiment = factor(sentiment, levels = ordem_sent)) %>% 
    filter(album_name == input_album) %>% 
    # group_by(SName, sentiment) %>% count() %>% 
    # ungroup() %>% 
    group_by(SName) %>% 
    mutate(n_sentiments = n()) %>% 
    arrange(desc(n_sentiments), sentiment)
  
  df %>% 
    group_by(sentiment) %>% 
    e_charts(SName) %>% 
    e_bar(prop, stack = "grp") %>%
    e_y_axis(max = 1) %>% 
    e_flip_coords() %>%
    e_grid(left = "20%") %>% 
    e_color(c("#12753F", "#4D976F", "#88BA9F", "#C3DCCF", "#EED8D8",
              "#DEB1B1", "#CD8B8B", "#BD6464", "#AC3D3D", "#9C1717")) %>% 
    e_tooltip(trigger = "axis", backgroundColor = "rgba(255,255,255,0.8)",
              borderColor = '#333', borderWidth = 1, 
              textStyle = list(color = '#333'))
  
}
```

### Is This It

The album _Is This It_ has a lot of Negative sentiment, mainly the song which name the album, [Is This It](https://www.youtube.com/watch?v=Hgqp7l9s_9o), on the other hand we have the song [Last Night](https://www.youtube.com/watch?v=TOypSnKFHrE) with the biggest proportion of words with Positive sentiments. I believe in those two songs the instrumental reflects those sentiments too. In general, the sentiments in the album seem balanced.

```{r echo=FALSE}
prop_sent_by_song("Is This It")
```

### Room On Fire

Here in _Room on Fire_, the song [The End Has No End](https://www.youtube.com/watch?v=8sQoX12zo-A) is the the one with the biggest amount of Negative words, while [Meet Me In The Bathroom](https://www.youtube.com/watch?v=Ykvf7oR0JBY) has the biggest amount of Positive words. Again, the album is balanced in the sentiments looking at all songs.

```{r echo=FALSE}
prop_sent_by_song("Room On Fire")
```

### First Impressions of Earth

In the third album of the band, we can see that the song [Killing Lies](https://www.youtube.com/watch?v=7BhWk7knpfo) has a significant proportion of Negative words and other negative feelings, while the famous [You Only Live Once](https://www.youtube.com/watch?v=pT68FS3YbQ4) has a bunch of Positive words. In these cases, again the rhythm seems to accompany the sentiments.

```{r echo=FALSE}
prop_sent_by_song("First Impressions Of Earth")
```

### Angles

Now, in the _Angles_ album we have [You're So Right](https://www.youtube.com/watch?v=L-5Tdlhmh0Y) with the biggest proportion of Negative sentiments and [Two Kind Of Happinnes](https://www.youtube.com/watch?v=dr-KUP55hC8) in the opposite situation. Looking at all the songs, this album has more proportion of feelings classified as negative.

```{r echo=FALSE}
prop_sent_by_song("Angles")
```

### Comedown Machine

Here we see a some interesting behaviors, we have a song which contains just words with negative aspects, [Call it Fate, Call it Karma](https://www.youtube.com/watch?v=Txn5-dKLFHg), on the other side, [Tap Out](https://www.youtube.com/watch?v=6KOT5kg59KI) has only positive aspects. The other songs have a behavior pretty much similar with the previous albums.

```{r echo=FALSE}
prop_sent_by_song("Comedown Machine")
```

### Future Present Past

In this EP, with only 3 songs, the songs are organized in in the top of positiviness with [Oblivious](https://www.youtube.com/watch?v=jEjdwhVuW74), followed by [Threat of Joy](https://www.youtube.com/watch?v=IJNgvS-sA-s) and [Drag Queen](youtube.com/watch?v=ts7cgeZC5J0). 

```{r echo=FALSE}
prop_sent_by_song("Future Present Past")
```

### The New Abnormal

About the last album of the band (but I hope more is coming lol) it is possible to see that [The Adults Are Talking](https://www.youtube.com/watch?v=ewOPQZZn4SY) has the biggest proportion of negative sentiments, while [Ode to the Mets](https://www.youtube.com/watch?v=BjC0KUxiMhc) has the biggest proportion of positive sentiments, although, this proportion represents just a little more then 50%. This is the album with the biggest proportion of negative between all songs.

```{r echo=FALSE}
prop_sent_by_song("The New Abnormal")
```

### Others

And finally we have some Side-B songs, demos and covers from the band and that were available on the site where I collect the lyrics. The most positives songs are Elephant Song, [Hawaii](https://www.youtube.com/watch?v=Ccqyg58VAHI) and [I'll Try Anything Once](https://www.youtube.com/watch?v=pjmaj-wtAPs) (by the way, this is my favorite song ever). And with the negatives there is [Modern Girls & Old Fashioned Men](https://www.youtube.com/watch?v=q34GQO2LFKU).

Fun Fact: They realesed the The Singles while I was writing this document!

```{r echo=FALSE}
prop_sent_by_song("Others")
```
 
## {.tabset .tabset-fade .tabset-pills}

```{r}
gauge_trios <- function(sent){
  
  top_3 <- sent_por_mus %>% 
    mutate(SName = ifelse(SName == "Modern Girls & Old Fashioned Men", 
                          "Modern Girls & \n Old Fashioned Men",
                          SName)) %>% 
    filter(sentiment == sent) %>% 
    slice_max(prop, n = 3)
  
  g1 <- e_charts() %>% # O outro modelo é mais bonitinho
  e_gauge(as.numeric((top_3[1,5]*100) %>% round(1)), 
          paste0("\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n", top_3[1,1]),
          z = 1)

  g2 <- e_charts() %>% 
  e_gauge(as.numeric((top_3[2,5]*100) %>% round(1)), 
          paste0("\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n", top_3[2,1])) 

  g3 <- e_charts() %>% 
  e_gauge(as.numeric((top_3[3,5]*100) %>% round(1)), 
          paste0("\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n", top_3[3,1])) 

  e_arrange(g1, g2, g3, rows = 1, cols = 3)
  
}
```

Now, the next analysis is similar, but given a sentiment let's look  which songs have the biggest proportion. Here I select the top 3 in gauges. 

### Anger

The three songs with the biggest proportion of anger words are: [Is This It](https://www.youtube.com/watch?v=Hgqp7l9s_9o), [You're So Right](https://www.youtube.com/watch?v=L-5Tdlhmh0Y) and [The Adults Are Talking](https://www.youtube.com/watch?v=ewOPQZZn4SY), all of them with more than 1/5 of the words as anger sentiments. Each song is from a different album, one in the first album, one in the middle of the career and the last one from the last album.

```{r echo=FALSE}
gauge_trios("Anger")
```


### Anticipation

About the Anticipation sentiment, we can see that the song [You Talk Way Too Much](https://www.youtube.com/watch?v=G9OLlofojX8) has 63% of the words with this sentiment, which is incredible, in the second position we have [Call It Fate, Call It Karma](https://www.youtube.com/watch?v=Txn5-dKLFHg) with 50% of Anticipation words and then [Vision of Division](https://www.youtube.com/watch?v=jBx9gQyiYoo). Also, each song is from a different album.

```{r echo=FALSE}
gauge_trios("Anticipation")
```

### Disgust

When we see the Disgust sentiment, [Call It Fate, Call It Karma](https://www.youtube.com/watch?v=Txn5-dKLFHg) is present again, followed by At The Summer, probably a cover from the band, and next we have [At The Door](https://www.youtube.com/watch?v=9CAz_vvsK9M).

```{r echo=FALSE}
gauge_trios("Disgust")
```


### Fear

Now, we can see the songs with the biggest proportion of Fear related words, the first one is [Ask Me Anything](https://www.youtube.com/watch?v=UsW040wrMNA), followed by the EP song [Drag Queen](https://www.youtube.com/watch?v=mBotY_n27VA) and in the third place we have [50/50](https://www.youtube.com/watch?v=_3YYEU4_x_0)

```{r echo=FALSE}
gauge_trios("Fear")
```

### Joy

[Laaaaaaaaast Nite](https://www.youtube.com/watch?v=TOypSnKFHrE) is the song with the biggest amount of Joyfull words among The Strokes songs, next we have [Tap Out](https://www.youtube.com/watch?v=6KOT5kg59KI) with almost 29% of words with Joy sentiment, and finally [Meet Me In The Bathroom](https://www.youtube.com/watch?v=Ykvf7oR0JBY).

```{r echo=FALSE}
gauge_trios("Joy")
```

### Negative

Again we see [Is This It](https://www.youtube.com/watch?v=Hgqp7l9s_9o), now with a expressive proportion of negative words, with a similar value there is [Juicebox](https://www.youtube.com/watch?v=GoltwBHXCx8) and them the cover song Rhythm Song from a Demo?

```{r echo=FALSE}
gauge_trios("Negative") 
```

### Positive

About the Positive sentiment words, [Oblivious](https://www.youtube.com/watch?v=jEjdwhVuW74), with more than 50% of the song, followed by [Tap Out](https://www.youtube.com/watch?v=6KOT5kg59KI) and then [Laaaaaaaaast Nite](https://www.youtube.com/watch?v=TOypSnKFHrE), which has also a lot of joyfull words.

```{r echo=FALSE}
gauge_trios("Positive")
```

### Sadness

The song with the biggest proportion of sadness words is [Modern Girls & Old Fashion Men](https://www.youtube.com/watch?v=38NWydYtEKY), the second one is [Post Modern Girls](https://www.youtube.com/watch?v=kin3__wyOos), both with Regina Spektor (what a coincidence), and [Take It Or Leave It](https://www.youtube.com/watch?v=bG7ZMiH6xA4) in the third position.

```{r echo=FALSE}
gauge_trios("Sadness") 
```

### Surprise

About the surprise element, again, you see [Take It Or Leave It](https://www.youtube.com/watch?v=bG7ZMiH6xA4), the next song is [Metabolism](https://www.youtube.com/watch?v=5YEHqiyb7AE) and there is also [Automatic Stop](https://www.youtube.com/watch?v=wveUjX6KFR8). Again a case which every song is from an album.

```{r echo=FALSE}
gauge_trios("Surprise")
```

### Trust

[Tap Out](https://www.youtube.com/watch?v=6KOT5kg59KI) is the song with the biggest proportion of trust sentiments, together we see [Ode To The Mets](https://www.youtube.com/watch?v=BjC0KUxiMhc) and [Alone, Together](https://www.youtube.com/watch?v=oUW7V4X0My0)

```{r echo=FALSE}
gauge_trios("Trust")
```


<!-- ## The Afinn Tecniche -->

<!-- Other tecnique to analyse text -->

<!-- ```{r message = F} -->
<!-- afinn <- get_sentiments("afinn") -->

<!-- sent_num_por_mus <- songs %>% select(c(2,4)) %>%  -->
<!--   unnest_tokens(word, letras) %>% -->
<!--   anti_join(stop_words) %>% -->
<!--   group_by(word) %>%  -->
<!--   count() %>% ungroup() %>%  -->
<!--   inner_join(afinn) %>%  -->
<!--   filter(word != "yeah") -->
<!-- ``` -->

<!-- Ainda tenho que sumarisar o total de negatividade por música -->


<!-- ```{r message = F} -->
<!-- sent_num_por_mus %>%  -->
<!--   e_charts() %>%  -->
<!--   e_histogram(value) %>%  -->
<!--   e_tooltip(backgroundColor = "rgba(255,255,255,0.8)",  -->
<!--             borderColor = '#333', borderWidth = 1, -->
<!--             textStyle = list(color = '#333')) -->
<!-- ``` -->

<!-- ```{r message = F} -->
<!-- sent_num_por_mus %>%  -->
<!--   e_charts(value) %>%  -->
<!--   e_scatter(n, name = "Frequency") %>%  -->
<!--   e_tooltip(backgroundColor = "rgba(255,255,255,0.8)",  -->
<!--             borderColor = '#333', borderWidth = 1, -->
<!--             textStyle = list(color = '#333')) -->
<!-- ``` -->



<!-- # Term Frequency -->

<!-- ```{r message = F} -->
<!-- tf_idf <- songs %>% select(c(2, 4, 5)) %>%  -->
<!--   unnest_tokens(word, letras) %>% -->
<!--   anti_join(stop_words) %>%  -->
<!--   group_by(SName, album_name) %>%  -->
<!--   count(word) %>% ungroup() %>%  -->
<!--   bind_tf_idf(word, SName, n) -->

<!-- tf_idf %>%           -->
<!--   e_chart() %>%  -->
<!--   e_histogram(tf_idf) %>%  -->
<!--   e_tooltip(backgroundColor = "rgba(255,255,255,0.8)",  -->
<!--             borderColor = '#333', borderWidth = 1, -->
<!--             textStyle = list(color = '#333')) -->

<!-- tf_idf %>%          # O quanto isso faria sentido? -->
<!--   e_chart(tf) %>%  -->
<!--   e_scatter(idf) %>%  -->
<!--   e_tooltip(backgroundColor = "rgba(255,255,255,0.8)",  -->
<!--             borderColor = '#333', borderWidth = 1, -->
<!--             textStyle = list(color = '#333')) -->
<!-- ``` -->

<!-- ## {.tabset .tabset-fade .tabset-pills} -->

<!-- ```{r message = F} -->
<!-- tf_idf_by_song <- function(input_album){ -->

<!--   tf_idf %>% -->
<!--     filter(album_name == input_album) %>%  -->
<!--     slice_max(tf_idf, n = 10) %>%  -->
<!--     group_by(SName) %>%  -->
<!--     e_charts(word, timeline = T) %>%  -->
<!--     e_bar(tf_idf, legend = F, name = "Ajusted Frequency") %>% -->
<!--     e_grid(left = "30%") %>%  -->
<!--     e_timeline_opts(top = 'middle', -->
<!--                     right = '100%', -->
<!--                     orient = "vertical", -->
<!--                     label = list(position = 'left'), -->
<!--                     controlStyle = list(showPlayBtn = F, itemSize = 0, itemGap = 110), -->
<!--                     lineStyle = list(show = F), -->
<!--                     itemStyle = list(color = 'rgba(128, 128, 128, 0.3)')) %>%  -->
<!--     e_tooltip(backgroundColor = "rgba(255,255,255,0.8)",  -->
<!--               borderColor = '#333', borderWidth = 1, -->
<!--               textStyle = list(color = '#333')) %>%  -->
<!--     e_flip_coords() -->

<!-- } -->
<!-- ``` -->

<!-- ### Is This It -->

<!-- ```{r echo=FALSE} -->
<!-- tf_idf_by_song("Is This It") -->
<!-- ``` -->


<!-- ### Room On Fire -->

<!-- ```{r echo=FALSE} -->
<!-- tf_idf_by_song("Room On Fire") -->
<!-- ``` -->

<!-- ### First Impressions of Earth -->

<!-- ```{r echo=FALSE} -->
<!-- tf_idf_by_song("First Impressions Of Earth") -->
<!-- ``` -->

<!-- ### Angles -->

<!-- ```{r echo=FALSE} -->
<!-- tf_idf_by_song("Angles") -->
<!-- ``` -->

<!-- ### Comedown Machine -->

<!-- ```{r echo=FALSE} -->
<!-- tf_idf_by_song("Comedown Machine") -->
<!-- ``` -->

<!-- ### Future Present Past -->

<!-- ```{r echo=FALSE} -->
<!-- tf_idf_by_song("Future Present Past") -->
<!-- ``` -->

<!-- ### The New Abnormal -->

<!-- ```{r echo=FALSE} -->
<!-- tf_idf_by_song("The New Abnormal") -->
<!-- ``` -->

<!-- ### Others -->

<!-- ```{r echo=FALSE} -->
<!-- tf_idf_by_song("Others") -->
<!-- ``` -->

<!-- # Words Relationship -->

<!-- ```{r echo=FALSE, message = F} -->
<!-- duplas <- songs %>% select(c(2,4)) %>%  -->
<!--   unnest_tokens(bigram, letras, token = "ngrams", n = 2) %>% -->
<!--   separate(bigram, c("word1", "word2"), sep = " ") %>%  -->
<!--   filter(!word1 %in% stop_words$word, !word2 %in% stop_words$word) -->

<!-- sankey <- duplas %>% group_by(word1, word2) %>% count() %>% ungroup() -->

<!-- library(ggraph) -->
<!-- library(igraph) -->

<!-- bigram_graph <- sankey %>% -->
<!--   filter(n > 5) %>% -->
<!--   igraph::graph_from_data_frame() -->

<!-- a <- grid::arrow(type = "closed", length = unit(.15, "inches")) -->

<!-- ggraph(bigram_graph, layout = "fr") + -->
<!--   geom_edge_link(aes(edge_alpha = n), show.legend = FALSE, -->
<!--                  arrow = a, end_cap = circle(.07, 'inches')) + -->
<!--   geom_node_point(color = "lightblue", size = 5) + -->
<!--   geom_node_text(aes(label = name), vjust = 1, hjust = 1) + -->
<!--   theme_void() -->
<!-- ``` -->

# Spotify Data {.tabset .tabset-fade .tabset-pills}

It's time to focus in the Spotify features. They are all numeric and describe some aspects from the songs. Below there is a table with the description of the features, in case of curiosity. 

|__Variable__              |__Description__ |
|:------|:---------------------------------|
|danceability             | Danceability describes how suitable a track is for dancing based on a combination of musical elements including tempo, rhythm stability, beat strength, and overall regularity. A value of 0.0 is least danceable and 1.0 is most danceable. |
|energy                 | Energy is a measure from 0.0 to 1.0 and represents a perceptual measure of intensity and activity. Typically, energetic tracks feel fast, loud, and noisy. For example, death metal has high energy, while a Bach prelude scores low on the scale. Perceptual features contributing to this attribute include dynamic range, perceived loudness, timbre, onset r  | The estimated overall key of the track. Integers map to pitches using standard Pitch Class notation . E.g. 0 = C, 1 = C♯/D♭, 2 = D, and so on. If no key was detected, the value is -1. |
|loudness               | The overall loudness of a track in decibels (dB). Loudness values are averaged across the entire track and are useful for comparing relative loudness of tracks. Loudness is the quality of a sound that is the primary psychological correlate of physical strength (amplitude). Values typical range between -60 and 0 db.|
|mode                     | Mode indicates the modality (major or minor) of a track, the type of scale from which its melodic content is derived. Major is represented by 1 and minor is 0.|
|speechiness             | Speechiness detects the presence of spoken words in a track. The more exclusively speech-like the recording (e.g. talk show, audio book, poetry), the closer to 1.0 the attribute value. Values above 0.66 describe tracks that are probably made entirely of spoken words. Values between 0.33 and 0.66 describe tracks that may contain both music and speech, either in sections or layered, including such cases as rap music. Values below 0.33 most likely represent music and other non-speech-like tracks. |
|acousticness              | A confidence measure from 0.0 to 1.0 of whether the track is acoustic. 1.0 represents high confidence the track is acoustic.|
|instrumentalness       | Predicts whether a track contains no vocals. “Ooh” and “aah” sounds are treated as instrumental in this context. Rap or spoken word tracks are clearly “vocal”. The closer the instrumentalness value is to 1.0, the greater likelihood the track contains no vocal content. Values above 0.5 are intended to represent instrumental tracks, but confidence is higher as the value approaches 1.0. |
|liveness                 | Detects the presence of an audience in the recording. Higher liveness values represent an increased probability that the track was performed live. A value above 0.8 provides strong likelihood that the track is live. |
|valence                 | A measure from 0.0 to 1.0 describing the musical positiveness conveyed by a track. Tracks with high valence sound more positive (e.g. happy, cheerful, euphoric), while tracks with low valence sound more negative (e.g. sad, depressed, angry). |
|tempo                 | The overall estimated tempo of a track in beats per minute (BPM). In musical terminology, tempo is the speed or pace of a given piece and derives directly from the average beat duration. |

```{r}
boxplot_por_album <- function(var){
  
  # E as tooltips com Is This It em tudo??
  
  songs %>% 
    mutate(
      album_name = case_when(
        album_name == "First Impressions Of Earth" ~ "First\nImpressions\nOf Earth",
        album_name == "Comedown Machine" ~ "Comedown\nMachine",
        album_name == "Future Present Past" ~ "Future\nPresent\nPast",
        album_name == "The New Abnormal" ~ "The New\nAbnormal",
        T ~ album_name)
      ) %>% 
    pivot_wider(id_cols = SName, names_from = album_name, values_from = !!sym(var)) %>% 
    e_charts() %>% 
    e_boxplot(`Is This It`) %>% 
    e_boxplot(`Room On Fire`) %>% 
    e_boxplot(`First\nImpressions\nOf Earth`) %>% 
    e_boxplot(`Angles`) %>% 
    e_boxplot(`Comedown\nMachine`) %>% 
    e_boxplot(`Future\nPresent\nPast`) %>% 
    e_boxplot(`The New\nAbnormal`) %>% 
    e_boxplot(`Others`) %>%
    e_color("#AC3D3D") %>% 
    e_tooltip(backgroundColor = "rgb(255,255,255,0.8)", 
              borderColor = '#333', borderWidth = 1,
              textStyle = list(color = '#333')) %>% 
    e_x_axis(axisLabel = list(fontSize = 9)) # %>% 
    # e_y_axis(type ='category') %>% e_x_axis(type ='value')
  
}

jitter_por_album <- function(var){
  
  songs %>% 
    mutate(
      across(6:14, ~round(., 2)),
      album_name = case_when(
        album_name == "First Impressions Of Earth" ~ "First\nImpressions\nOf Earth",
        album_name == "Comedown Machine" ~ "Comedown\nMachine",
        album_name == "Future Present Past" ~ "Future\nPresent\nPast",
        album_name == "The New Abnormal" ~ "The New\nAbnormal",
        T ~ album_name),
      choosen_var = round(!!sym(var), 2),
      album_name = factor(album_name, levels=c("Is This It", "Room On Fire", "First\nImpressions\nOf Earth", "Angles", "Comedown\nMachine", "Future\nPresent\nPast", "The New\nAbnormal", "Others"))
      )  %>% 
    filter(album_name != "Fast Animals") %>% 
    arrange(album_name) %>% 
    e_charts(album_name) %>%  
    # e_scatter(choosen_var, symbol_size = 5, name=var) %>%
    e_scatter(choosen_var, jitter_factor = 2, symbol_size = 6, name=str_to_title(var), bind=SName) %>% 
    e_color("#AC3D3D") %>%
    e_tooltip(
        backgroundColor = "rgb(255,255,255,0.8)",
        borderColor = '#333', borderWidth = 1,
        textStyle = list(color = '#333')
     ) %>% 
    e_legend(show = F) %>% 
    e_x_axis(axisLabel = list(fontSize = 9)) # %>% 
    # e_y_axis(type ='category') %>% e_x_axis(type ='value')
  
}

top10var_por_album <- function(var){
  
  # Era para estar em outra ordem...
  
  renamed_songs <- songs %>% 
    mutate(
      across(6:14, ~round(., 2)),
      SName = case_when(
        SName == "I'll Try Anything Once (You Only Live Once Demo)" ~ "I'll Try Anything Once\n(You Only Live Once Demo)",
        SName == "Mercy Mercy Me (The Ecology)" ~ "Mercy Mercy Me\n(The Ecology)",
        SName == "Life Is Simple In The Moonlight" ~ "Life Is Simple\nIn The Moonlight", 
        T ~ SName)
      )
  
  g1 <- renamed_songs %>% 
    mutate() %>% 
    drop_na() %>%
    mutate(Var = !!sym(var)) %>% 
    slice_min(order_by = Var, n = 10) %>% 
    group_by(album_name) %>% 
    e_charts(SName) %>% 
    e_bar(Var, stack = "grp") %>% 
    e_flip_coords() %>% 
    e_labels(position = "right") %>% 
    e_grid(left = "40%") %>% 
    e_title("Lower Values") %>% 
    e_legend(bottom = 0, type = "scroll") %>% 
    e_tooltip(backgroundColor = "rgb(255,255,255,0.8)", 
              borderColor = '#333', borderWidth = 1,
              textStyle = list(color = '#333'))
  
  g2 <- renamed_songs %>% 
    drop_na() %>%
    mutate(Var = !!sym(var)) %>% 
    slice_max(order_by = Var, n = 10) %>% 
    group_by(album_name) %>% 
    e_charts(SName) %>% 
    e_bar(Var, stack = "grp") %>% 
    e_flip_coords() %>% 
    e_labels(position = "right") %>% 
    e_grid(left = "40%") %>% 
    e_title("Higher Values") %>%
    e_legend(bottom = 0, type = "scroll") %>% 
    e_tooltip(backgroundColor = "rgb(255,255,255,0.8)", 
              borderColor = '#333', borderWidth = 1,
              textStyle = list(color = '#333'))
  
  e_arrange(g2, g1, rows = 1, cols = 2)
  
}

# top10var_por_album <- function(var){
#   
#   # Era para estar em outra ordem...
#   
#   songs %>% 
#     drop_na() %>%
#     mutate(Var = !!sym(var)) %>% 
#     arrange(Var) %>%
#     slice(1:10, (n() - 9):n()) %>% 
#     mutate(Top = rep(c("Menores", "Maiores"), each = 10),
#            n = c(1:10, 10:1) %>% as.factor()) %>% 
#     group_by(Top) %>% 
#     e_charts(n, timeline = T) %>% 
#     e_bar(Var, stack = "grp", name = SName) %>% 
#     e_flip_coords() %>% 
#     e_labels(position = "right") %>% 
#     e_y_axis(show = F) %>% 
#     e_tooltip(backgroundColor = "rgb(255,255,255,0.8)", 
#               borderColor = '#333', borderWidth = 1,
#               textStyle = list(color = '#333')) %>% 
#     e_timeline_opts(top = 'middle',
#                     right = '100%',
#                     orient = "vertical",
#                     label = list(position = 'left'),
#                     controlStyle = list(showPlayBtn = F, itemSize = 0, itemGap = 110),
#                     lineStyle = list(show = F),
#                     itemStyle = list(color = 'rgba(128, 128, 128, 0.3)'))
#   
# }
```

## Danceability

Here we can see that the majority of The Strokes song has betwenn 0.3 and 0.7 of the Score of Danceability of Spotify. Some of the "outliers" are: [15 Minutes](https://www.youtube.com/watch?v=-ovJyxcWkro) with the lowest score of Danceability, in the other side [Tap Out](https://www.youtube.com/watch?v=6KOT5kg59KI) has the biggest one. There is a curiosity, I would never imagine that [Hawaii](https://www.youtube.com/watch?v=Ccqyg58VAHI) has less "danceality" than [I'll Try Anything Once](https://www.youtube.com/watch?v=pjmaj-wtAPs), actually, I expect [Hawaii](https://www.youtube.com/watch?v=Ccqyg58VAHI) own the higher score.

```{r echo=FALSE}
jitter_por_album("danceability")
```

```{r echo=FALSE}
top10var_por_album("danceability")
```

## Energy

Between the lowest energy songs we have [Call It Fate, Call It Karma](https://www.youtube.com/watch?v=Txn5-dKLFHg), [I'll Try Anything Once](https://www.youtube.com/watch?v=pjmaj-wtAPs), [Call Me Back](https://www.youtube.com/watch?v=ToTNGU8Zaww), [Ask Me Anything](https://www.youtube.com/watch?v=UsW040wrMNA) and [At The Door](https://www.youtube.com/watch?v=9CAz_vvsK9M), all of them make pretty sense to me. While the most energy song is [Juicebox](https://www.youtube.com/watch?v=GoltwBHXCx8) very close to [You Talk Way Too Much](https://www.youtube.com/watch?v=G9OLlofojX8) and [Partners in Crime](https://www.youtube.com/watch?v=7w5tKFh9pd0). It is also possible to say that the songs from First Impressions on Earth have a little more energy than the other albums, in general.

```{r echo=FALSE}
jitter_por_album("energy")
```

```{r echo=FALSE}
top10var_por_album("energy")
```

## Loudness

About loudness, we see a repeat of some songs talked before, they are [Call It Fate, Call It Karma](https://www.youtube.com/watch?v=Txn5-dKLFHg), [I'll Try Anything Once](https://www.youtube.com/watch?v=pjmaj-wtAPs), [Call Me Back](https://www.youtube.com/watch?v=ToTNGU8Zaww) and [Ask Me Anything](https://www.youtube.com/watch?v=UsW040wrMNA) in the bottom of the chart. While the biggest are [On the Other Side](https://www.youtube.com/watch?v=fzR1-OacD8o), [You Only Live Once](https://www.youtube.com/watch?v=pT68FS3YbQ4), [Juicebox](https://www.youtube.com/watch?v=GoltwBHXCx8) and [The Way It Is](https://www.youtube.com/watch?v=Kj1a7WQta4w). It is curious to see that the first album was one of the lowest,in the general, and the next one has already the opposite behavior.

```{r echo=FALSE}
jitter_por_album("loudness")
```

```{r echo=FALSE}
top10var_por_album("loudness")
```

## Speechiness

Here we can see that The Strokes songs aren't too spoken, the majority of the songs has less than 0.06 of the Speechiness Score. Again [Juicebox](https://www.youtube.com/watch?v=GoltwBHXCx8) is a highlight the next one is [All The Time](https://www.youtube.com/watch?v=TJC8zeu3MHk). The song of the less value of Speechiness is [Between Love & Hate](https://www.youtube.com/watch?v=b2A4gJnHsVg).

```{r echo=FALSE}
jitter_por_album("speechiness")
```

```{r echo=FALSE}
top10var_por_album("speechiness")
```

## Acousticness

The songs in general have also low values to acoustic score, and the same musics with the low danceability are here in the maximum values: [Call It Fate, Call It Karma](https://www.youtube.com/watch?v=Txn5-dKLFHg), [I'll Try Anything Once](https://www.youtube.com/watch?v=pjmaj-wtAPs), [Call Me Back](https://www.youtube.com/watch?v=ToTNGU8Zaww), [Ask Me Anything](https://www.youtube.com/watch?v=UsW040wrMNA) and [At The Door](https://www.youtube.com/watch?v=9CAz_vvsK9M).

```{r echo=FALSE}
jitter_por_album("acousticness")
```

```{r echo=FALSE}
top10var_por_album("acousticness")
```

## Instrumentalness

This is the variable with the biggest variance in all albums, so it is difficult to highlight any song.

```{r echo=FALSE}
jitter_por_album("instrumentalness")
```

```{r echo=FALSE}
top10var_por_album("instrumentalness")
```

## Valence

~~Nick~~ Valence is about the positiveness in the song too, here the three biggest values are [You Only Live Once](https://www.youtube.com/watch?v=pT68FS3YbQ4), [One Way Trigger](https://www.youtube.com/watch?v=reifFcUoTKw) and [Alone, Together](https://www.youtube.com/watch?v=oUW7V4X0My0) and in the other side we have [All The Time](https://www.youtube.com/watch?v=TJC8zeu3MHk), [Selfless](https://www.youtube.com/watch?v=1-W6whvn8Bs) and [Heart In A Cage](https://www.youtube.com/watch?v=3dyNbMVfeyM). All seems pretty acurate. Maybe there is a decrease tendency relate to the time, in other words, the values are decreasing with the pass of the time.

```{r echo=FALSE}
jitter_por_album("valence")
```

```{r echo=FALSE}
top10var_por_album("valence")
```

## Tempo 

In the Tempo Score there are also a concentration in the values, with [Under Cover of Darkness](https://www.youtube.com/watch?v=_l09H-3zzgA) as a higlight and [15 Minutes](https://www.youtube.com/watch?v=-ovJyxcWkro) and [Hard to Explain](https://www.youtube.com/watch?v=BXkm6h6uq0k) in the oppostite spectrum.

```{r echo=FALSE}
jitter_por_album("tempo")
```

```{r echo=FALSE}
top10var_por_album("tempo")
```

<!-- #  -->

<!-- Here there are the correlation between the spotify features seen.   -->

<!-- ```{r} -->
<!-- # Na verdade, eu nem lembro o que eu tava tentando fazer com isso -->

<!-- shared_variavel1 <- songs %>%  -->
<!--   pivot_longer(6:14, names_to = "var", values_to = "valor") %>%  -->
<!--   select(6:7) %>%  -->
<!--   SharedData$new() -->
<!-- shared_variavel2 <- songs %>%  -->
<!--   pivot_longer(6:14, names_to = "var", values_to = "valor") %>%  -->
<!--   select(6:7) %>%  -->
<!--   SharedData$new() -->

<!-- bscols(widths = c(3, NA), -->

<!--   list( -->
<!--     filter_select("varx", "Eixo X", shared_variavel1, ~var, -->
<!--                   multiple = F), -->
<!--     filter_select("vary", "Eixo Y", shared_variavel2, ~var, -->
<!--                   multiple = F) -->
<!--   ), -->

<!--   ggplotly( # QUAL O PROBLEMA DO FILTRO?? -->

<!--     ggplot() + -->
<!--       geom_point(aes(x = shared_variavel1$data() %>% pull(valor), -->
<!--                      y = shared_variavel2$data() %>% pull(valor))) -->

<!--     ) -->

<!-- ) -->

<!-- ``` -->

# Similarities

The next analysis are about the similarity between the songs, it is possible to measure those similarities using the Spotify features and the words from each song. The next visualizations show these informations.

## Similarity between lyrics

First, we will look to the lyrics, the similarity here was calculated with the _Cossine Similarity_, largely used to describe the similarity between points. When we have two points in a plan, they can be represented as vectors from the (0,0) coordinate in the plan and it is possible to measure the angle between those vectors, if this angle is small, we can say that the points are similar, in other words, the lower the Cossine value bigger the similarity.

As we can see, the calculus is done with pairs of songs, with the table below we can set a song and look which songs are more or less similar or to check a specific pair in your mind.

```{r message = F}
freq_by_song <- songs %>% select(c(2,4)) %>% # provavelmente posso apagar
  unnest_tokens(word, letras) %>%
  anti_join(stop_words) %>%
  group_by(SName, word) %>%
  count() %>%
  ungroup() %>% group_by(SName) %>%
  #slice_max(order_by = n, n = 10) %>%  o cara usou muito mesmo
  pivot_wider(1:3, names_from = SName, values_from = n, values_fill = 0)

cosine_sim <- function(a, b) crossprod(a,b)/sqrt(crossprod(a)*crossprod(b))

calc_cos_sim <- function(name, freq = freq_by_song) {

  freq <- freq %>% select(-c(word))

  sapply(freq, list) %>%
    map(cosine_sim, freq %>% pull(name)) %>%
    unlist() %>%
    as.data.frame() %>%
    rename(Similarity = ".")

}

similaritys <- mapply(calc_cos_sim, freq_by_song %>% names() %>% .[-1]) %>%
  bind_cols() %>%
  pivot_longer(1:85, names_to = "Song1", values_to = "Similarity") %>%
  mutate(Song1 = str_remove(Song1, ".Similarity"),
         Song2 = freq_by_song %>% names() %>% .[-1] %>% rep(each = 85),
         Similarity = round(Similarity, 3)) %>%
  filter(Similarity != 1) %>%
  relocate(Similarity, .after = last_col())

shared_similaritys <- SharedData$new(similaritys)

bscols(widths = c(3, NA),

  list(
    filter_select("song1", "Choose the 1° Song",
                  shared_similaritys, ~Song1, multiple = F),
    filter_select("song2", "Choose the 2° Song",
                  shared_similaritys, ~Song2, multiple = F)
  ),

  datatable(
    shared_similaritys, width = 500,
    class = "cell-border hover row-border",
    options = list(
      dom = 'tip',
      initComplete = JS(
        "function(settings, json) {",
        "$(this.api().table().header()).css({'color' : '#ffffff'});",
        "$(this.api().table().header()).css({'background-color': '#749eb3'});",
        "}"
        )
      )
  ) 

)
```

Some interresting highlights are: 

 - Songs that are demos are the most correlated with their final version, obviously;
 - The first unrelateds and released songs that appear is the pair [Vision of Division](https://www.youtube.com/watch?v=jBx9gQyiYoo) and [Under Cover of Darkness](https://www.youtube.com/watch?v=_l09H-3zzgA) with a score equals to 0.645;
 - The song [You Talk Way Too Much](https://www.youtube.com/watch?v=G9OLlofojX8) is highly related with a bunch of songs;

## Similarity between features

<!-- Diferente da outra função, por que as colunas não são as músicas; -->
<!-- Aqui já pode ser distância também; -->

Here the Spotify features were used, and the chosen distance was the Euclidian Distance, so a big distance means low similarity and vice versa. The use of the table is the same as the previous.  

Some interresting highlights are:

- The pair with the biggest distance is [Under Cover of Darkness](https://www.youtube.com/watch?v=_l09H-3zzgA) and [Hard To Explain](https://www.youtube.com/watch?v=BXkm6h6uq0k), with a distance equal to 117.41;
- Actually, [Under Cover of Darkness](https://www.youtube.com/watch?v=_l09H-3zzgA) is present in a bunch of the top pairs distances (the firsts 15 pairs, to be more accurate, and in others positions), maybe we can say this is the most different song of the band? Besides that, the nearest song is [Not The Same Anymore](https://www.youtube.com/watch?v=sY1U0eJV5es) with a distance of 22.64;
- In the other side, the pair more similar is [Tap Out](https://www.youtube.com/watch?v=6KOT5kg59KI) and [What Ever Happened?](https://www.youtube.com/watch?v=yQOJTLylm-A) with a distance of 0.48; 


```{r}
distances <- get_dist(songs %>%
                         column_to_rownames("SName") %>%
                         select(5:13) %>% drop_na()) %>%
  as.matrix() %>%
  as.data.frame() %>%
  rownames_to_column("Song1") %>%
  pivot_longer(-1, names_to = "Song2", values_to = "Distance") %>%
  filter(`Distance` != 0) %>%
  mutate(`Distance` = round(`Distance`, 2))

shared_distances <- SharedData$new(distances)

bscols(widths = c(3, NA),

  list(
    filter_select("song1", "Escolha a 1° Música",
                  shared_distances, ~Song1, multiple = F),
    filter_select("song2", "Escolha a 2° Música",
                  shared_distances, ~Song2, multiple = F)
  ),

  datatable(
    shared_distances, width = 500,
    class = "cell-border hover row-border",
    options = list(
      dom = 'tip',
      initComplete = JS(
        "function(settings, json) {",
        "$(this.api().table().header()).css({'color' : '#ffffff'});",
        "$(this.api().table().header()).css({'background-color': '#749eb3'});",
        "}"
        )
      )
  ) 
  # %>% 
  #   formatStyle(
  #     'Distance',
  #     backgroundColor = '#B2B1B9'
  # )

)

```

What if the two similarities have a association? This is the question the next charts try to answer. Unfortunately, the charts show an unexpected relation, I was expecting a negative correlation but the two measures doesn't seen to be so correlated. 

Maybe some of the points more close with the desired correlation are Hard to Explain vs Undercover the Darkness and  15 Minutes vs Undercover the Darkness, where we see a high distance with a low cossine similarity, while the pair Fast Animals vs Slow Animals shows the completely opposite pattern. 

A attempt with the inverse of the Distance was also made to try see the features with the same logic of similarity, but the relation keep pretty similar.


```{r message=F}
similaritys %>%
  inner_join(distances) %>%
  mutate(Dupla = paste(Song1, Song2, sep = " vs ")) %>%
  e_chart(Similarity) %>%
  e_scatter(`Distance`,
            bind = Dupla # Define nomes para as observações
            ) %>%
  e_loess(`Distance` ~ Similarity, showSymbol = FALSE) %>%
  e_lm(`Distance` ~ Similarity, showSymbol = FALSE) %>%
  e_axis_labels(x = "Cossine Similarity - Lyrics              ", y = "              Euclydian Distance - Spotify Features") %>% 
  e_tooltip(formatter = htmlwidgets::JS("
      function(params){
        return('<strong>' + params.name +
               '</strong><br />Similarity: ' + params.value[0] +
               '<br />Distance: ' + params.value[1])
      }
    "),
      backgroundColor = "rgb(255,255,255,0.8)",
      borderColor = '#333', borderWidth = 1,
      textStyle = list(color = '#333')
  )
```


<!-- ```{r} -->
<!-- # 1/`Distance`,  -->

<!-- similaritys %>% -->
<!--   inner_join(distances) %>% -->
<!--   mutate(Dupla = paste(Song1, Song2, sep = " vs "), -->
<!--          `Distance` = (`Distance` - min(`Distance`))/(max(`Distance`) - min(`Distance`))) %>% -->
<!--   e_chart(Similarity) %>% -->
<!--   e_scatter(`Distance`, -->
<!--             bind = Dupla # Define nomes para as observações -->
<!--             ) %>% -->
<!--   e_loess(`Distance` ~ Similarity, showSymbol = FALSE) %>% -->
<!--   e_lm(`Distance` ~ Similarity, showSymbol = FALSE) %>% -->
<!--   e_tooltip(formatter = htmlwidgets::JS(" -->
<!--       function(params){ -->
<!--         return('<strong>' + params.name + -->
<!--                '</strong><br />Similarity: ' + params.value[0] + -->
<!--                '<br />Distance: ' + params.value[1]) -->
<!--       } -->
<!--     "), -->
<!--       backgroundColor = "rgb(255,255,255,0.8)", -->
<!--       borderColor = '#333', borderWidth = 1, -->
<!--       textStyle = list(color = '#333') -->
<!--   ) -->
<!-- ``` -->


# Cluster

The last part of the analysis is the creation of clusters with the songs. This is equivalent to create groups of songs that share characteristics and in other words, are similar. Only the Spotify features were considered.

<!-- Only the Spotify features were considered, so in the totality we have 73 songs, in multivariate techniques it is usual to work with at least 5 rows to each feature in the analysis, which it is not the case here. But we will go forward.  -->

Firsts things first, it is necessary to choose the number of clusters we will predict, below we have a plot where is possible to see the total within sum of square, increasing the number of clusters always decrease this metric, so the interesting here is to choose the value that the rate of change starts to be low. The number 4 seems to be a good candidate, but during experiment, I decided to use 3, because of the quality of the result.

```{r}
set.seed(123)

data_cluster <- songs %>% 
  drop_na() %>% 
  column_to_rownames("SName") %>% 
  select(5:13) %>% 
  scale()

fviz_nbclust(data_cluster, kmeans, method = "wss")
```

<!-- Com 5 clusters, um deles fica com apenas uma observação... -->
<!-- - Outra coisa: são 9 variáveis, para um pca decente, precisaria de pelo menos 90 músicas, e aqui eu tenho 73... -->

Let's go to the clusters, I used the K-Means algorithm to create the clusters and to represent them I created a Principal Component Analysis, take the two PCAs that contains the highest variability in the plot in order to analyze how the clusters look.

In that way, the three groups are totally separated, with really different sizes, the orange one has only six songs and it its clear that these songs are the most calm ones from the discography, the lilac group has 21 songs, while the last one has more than the double, 47 songs.

```{r}
k3 <- kmeans(data_cluster, centers = 3, nstart = 25)
pca <- prcomp(data_cluster)

# fviz_cluster(k3, geom = "point",  data = data_cluster) + ggtitle("k = 3")

cbind(data_cluster,
      agrupamento = fitted(k3, method = "class"),
      pca$x[,1:2]) %>%
    as.data.frame() %>%
    mutate(across(everything(), as.numeric),
           across(everything(), ~round(., 3)),
           # agrupamento = case_when(agrupamento == 2 ~ 0,
           #                         agrupamento == 1 ~ 2,
           #                         T ~ agrupamento),
           # agrupamento = ifelse(agrupamento == 0, 1, agrupamento),
           agrupamento = ifelse(agrupamento > 1, agrupamento + 1, agrupamento),
           agrupamento = ifelse(agrupamento == 4, 2, agrupamento),
           agrupamento = paste("Group", agrupamento)) %>%
    arrange(agrupamento) %>%
    rownames_to_column("SName") %>%
    group_by(agrupamento) %>%
    e_charts(PC1) %>%
    e_scatter(PC2, bind = SName, symbol_size = 10) %>%
    e_axis_labels(x = "\n \n \n \n \n \n \n \n \n \n \n \n \n \n \n \n \n \n PCA1 (30.1%)",
                  y = "PCA2 (17.3%)                                                                                                    ") %>%
    e_color(c("#FE5D26", "#7EBC89", "#BAA5FF", "#D62246")) %>%
    e_tooltip(
        formatter = htmlwidgets::JS("
          function(params){return('<strong>' + params.name) +
                                  '</strong><br />x: ' + params.value[0] +
                                  '<br />y: ' + params.value[1]}"),
        backgroundColor = "rgba(255,255,255,0.8)", borderColor = '#333',
        borderWidth = 1, textStyle = list(color = '#333'))
```

Below there are the songs and their clusters. It is possible to filter the groups and look each song and also their features. 

```{r}
groups <- songs %>%
  select(2, 6:14) %>%
  drop_na() %>%
  mutate(Group = fitted(k3, method = "class"),
         Group = ifelse(Group > 1, Group + 1, Group),
         Group = ifelse(Group == 4, 2, Group))

shared_groups <- SharedData$new(groups)

bscols(widths = c(3, NA),

  list(
    filter_select("agrupamento", "Pick a Group",
                  shared_groups, ~Group, multiple = F)
  ),

  datatable(shared_groups, width = 500,
            class = "cell-border hover row-border",
    options = list(
      dom = 'tip',
      scrollX = TRUE,
      initComplete = JS(
        "function(settings, json) {",
        "$(this.api().table().header()).css({'color' : '#ffffff'});",
        "$(this.api().table().header()).css({'background-color': '#749eb3'});",
        "}"
        )
      )
    )

)
```


## Each group {.tabset .tabset-pills .tabcontent}

In order to analyze the properties of each of the groups, some boxplots about each features are seem below. That's a way to confirm if the songs in the same group are similar and if there differences among the groups.

In summary, seems that the Group 1 has the calm songs, the Group 2 the happy (?) ones and in the Group 3 has left the loud and dirty ones (??)

```{r}
boxplot_por_grupo <- function(var){

  # Ainda estressada com os labels do eixo x;
  # E as tooltips com Is This It em tudo??

  groups %>%
    mutate(Group = paste("Group", Group)) %>%
    pivot_wider(id_cols = SName, names_from = Group, values_from = !!sym(var)) %>%
    e_charts() %>%
    e_boxplot(`Group 1`) %>%
    e_boxplot(`Group 2`) %>%
    e_boxplot(`Group 3`) %>%
    # e_boxplot(`Grupo 4`) %>%
    e_color("#AC3D3D") %>%
    e_tooltip(backgroundColor = "rgb(255,255,255,0.8)",
              borderColor = '#333', borderWidth = 1,
              textStyle = list(color = '#333'))

}
```


### Danceability

Looking at the Danceability, we can say that the Group 2 has higher values in general.

```{r echo=FALSE}
boxplot_por_grupo("danceability")
```

### Energy

The energy has a ascending increase among the groups, it is clear that the first one is the lowest energy.

```{r echo=FALSE}
boxplot_por_grupo("energy")
```

### Loudness

The same pattern from the Energy score is seem with the Loudness.

```{r echo=FALSE}
boxplot_por_grupo("loudness")
```

### Speechiness

The Speechiness is pretty similar in every group. Remember from the scatter plots where we had all the songs, that this feature were generally low. 

```{r echo=FALSE}
boxplot_por_grupo("speechiness")
```

### Acousticness

In this case, the group 1 is the highlight, with values of acousticness much higher than the other groups.

```{r echo=FALSE}
boxplot_por_grupo("acousticness")
```

### Instrumentalness

The Instrumentalness is similar in all groups and also has a high variability.

```{r echo=FALSE}
boxplot_por_grupo("instrumentalness")
```

### Valence

Here, the second group is the highlight with the biggest mean but also with the biggest variance.

```{r echo=FALSE}
boxplot_por_grupo("valence")
```

### Tempo

Yeah... Also pretty much similar, just the Group 3 with higher variability.

```{r echo=FALSE}
boxplot_por_grupo("tempo")
```

# 

<div class = "meunome">

<!-- <audio controls autoplay> -->
<!--   <source src = "Oasis.mp3" type = "audio/mpeg"/> -->
<!-- </audio> -->

<br/>

by Laura Alexandria de Oliveira

<ul class = "redes">

<li><a class="fas fa-user" href = "https://lauraalexandria.github.io/"></a></li>
<li><a class="fab fa-github" href = "https://github.com/lauraalexandria"></a></li>
<li><a class="fab fa-linkedin" href = "https://www.linkedin.com/in/laura-alexandria-de-oliveira/"></a></li>

</ul>
</div>

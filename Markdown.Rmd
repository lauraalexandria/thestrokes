---
output: 
  html_document: 
    code_folding: "hide"
    df_print: default
    toc: yes
    toc_depth: 1
    toc_float:
      collapsed: no
---

```{css, echo=FALSE}
@import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Raleway:ital,wght@1,600&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Open+Sans&display=swap');


body {
  text-align: justify;
  font-family: 'Open Sans', sans-serif;
}

.title {
  color: #A92323;
  font-size: 10px; 
  font-family: 'Montserrat', sans-serif;
  text-align: right;
  position: fixed;
  top: 5%;
  right: 74%;
  width: 300px;
}

.date {
  color: #dedede;
  font-size: 20px;
  font-family: 'Raleway', sans-serif;
  text-align: right;
  position: fixed;
  top: 27%;
  right: 74%;
  width: 250px;
}

#TOC {
  background: url("https://vandal-us.s3.amazonaws.com/spree/products/38559/original/uploads_2F1542892606452-ri8xswrviim-024e6ecc4b1cc21eded6b5f393e95096_2FStrokes-Vandal.jpg");
  background-size: contain;
  padding-top: 250px !important;
  background-repeat: no-repeat;
  color: #595260;
  font-family: 'Poppins', sans-serif;
  border-color: #ffffff
}
  
.tocify {
  border: none;
}
  
.list-group-item.active, .list-group-item.active:focus, .list-group-item.active:hover {
    background-color: #595260 /*Cor do background da TOC quando selecionada*/
}  

div.meunome {
 text-align: justify;
 position: fixed;
 top: 88%;
 right: 77%;
}
 
.section h1 {
  color: #548CA8;
	font-family: 'Montserrat', sans-serif;
	border-bottom: 1px solid #dedede
}
  
.section h2 {
  color: #B2B1B9;
  font-family: 'Poppins', sans-serif;  
}
  
b, strong {
  color: #FF6F61;
}

mark {
  background-color: #FFBBA4;
}

a {
  color: #778bd9;
}

div.bloco {
  text-align: justify;
  padding: 1em;
  background: #f5eeeb;
  color: black;
  border: 5px solid white;
  border-radius: 10px;
}

div.metade {
  width: 50%;
  float: left;
  text-align: justify;
  padding: 1em;
  background: #f5eeeb;
  color: black;
  border: 5px solid white;
  border-radius: 10px;
}

div.meunome {
 text-align: justify;
 position: fixed;
 top: 75%;
 right: 77%;
}

ul.redes {
  position: fixed;
  top: 92%;
  right: 82%;
}

ul.redes li{
  list-style: none;
  float: left;
  size: 30px;
  margin-right: 7px;
}

ul.redes a{
  color: #dedede;
  size: 30px;
}

ul.redes a:hover{
  color: #595260;
  text-decoration: none;
}

.nav-pills > li > a {
    color: #595260;
}

.nav-pills > li.active > a, 
.nav-pills > li.active > a:hover, 
.nav-pills > li.active > a:focus {
    color: white;
    background-color: #595260;
    }

```



```{r message=F, warning=F}
library(tidyverse)
library(tidytext)
library(wordcloud2)
library(textdata) 
library(here)
library(echarts4r)
library(word2vec)
library(crosstalk)
library(DT)
library(plotly)
library(factoextra)

data("stop_words")  # Fixando as stopwords
stop_words <- stop_words %>% add_row(word = c("yeah", "gonna", "hey"))

source("WebScraping.R")
source("DadosSpotify.R")

letras <- apply(songs[,3], 1, get_lyric)

songs <- songs %>% 
  mutate(letras = tolower(letras)) %>% 
  filter(!str_detect(SName, "ep Version|early")) %>% # Evitar nomes repetidos;
  mutate(SName = case_when(                          # Corrigindo nomes;
     SName == "Mercy, Mercy Me" ~ "Mercy Mercy Me (The Ecology)",
     SName == 'Hawaii Aloha' ~ 'Hawaii',
     SName == "Why Are Sunday's So Depressing" ~ "Why Are Sundays So Depressing",
     SName == "Oblivious" ~ "Oblivius",
     T ~ SName),
    SName = str_to_title(SName)) %>% 
  left_join(dados_spotify, by = c("SName" = "track_name")) %>% 
  mutate(album_name = case_when(
     is.na(album_name) ~ "Others",
     album_name == "Juicebox" ~ "Others",
     album_name == "Heart In A Cage" ~ "Others",
     album_name == "You Only Live Once/Mercy Mercy Me" ~ "Others",
     T ~ album_name))


e_common(theme = "london")
#opções de tema: london, tech-blue
```


# Introduction

I love The Strokes, and a WebScrap 82 songs of them

# Word Clouds

```{r message=F, warning=F}
contagem <- songs %>% select(c(2,4)) %>%
  unnest_tokens(word, letras) %>%
  anti_join(stop_words) %>%
  count(word)

#wordcloud2(contagem %>% filter(n > 5))

contagem %>%
  filter(n > 5) %>%
  e_charts() %>%
  e_cloud(word, n, shape = "circle") %>% 
  e_tooltip(backgroundColor = "rgb(255,255,255,0.8)", 
            borderColor = '#333', borderWidth = 1,
            textStyle = list(color = '#333'))

```


# Number of words by Song

```{r message=FALSE, warning=FALSE}
num_por_song <- songs %>% select(c(2,4)) %>% 
  unnest_tokens(word, letras) %>%
  anti_join(stop_words) %>%
  group_by(SName) %>% 
  count() %>% ungroup()

num_por_song  %>% 
  e_charts() %>%
  e_histogram(n) %>% 
  e_tooltip(trigger = "axis", backgroundColor = "rgb(255,255,255,0.8)", 
            borderColor = '#333', borderWidth = 1,
            textStyle = list(color = '#333'))
```

```{r message=FALSE, warning=FALSE}
menor <- num_por_song %>% slice_min(order_by = n, n = 1)
menor_mus <- menor %>% pull(SName)
menor_quant <- menor %>% pull(n)
maior <- num_por_song %>% slice_max(order_by = n, n = 1)
maior_mus <- maior %>% pull(SName)
maior_quant <- maior %>% pull(n)
```

  
<div class = "metade">
Agora é ver se eu consigo deixar um do lado do outro...
</div>
  
<div class = "metade">
Here, I use 3 subunits of size 4 (4x3=12). The last column is used for a plot. You can read more about the grid system [here](bootstrap grid system). I got this result showing the following code in my R Markdown document.
</div>


<!-- # Proportion of Word in each song - é aqui que poderia entrar um ANÁLISE FATORIAL (O trem de similaridade já dá conta)  -->

<!-- Foram usadas 1489 palavras diferentes em todas as músicas/ ainda tem que melhorar a tooltip aqui! -->

<!-- In this analysis I select the 10 words more frequent and I summed the proportion of them in each song forming 2 variables, the first one with the 5 firsts and the second one with the remaining. Now I see that doesn't make sense.  -->

<!-- ```{r message=FALSE, warning=FALSE} -->
<!-- prop_por_song <- songs %>% select(c(2,4)) %>%  -->
<!--   unnest_tokens(word, letras) %>% -->
<!--   anti_join(stop_words) %>% -->
<!--   group_by(SName, word) %>%  -->
<!--   count() %>%  -->
<!--   ungroup() %>% group_by(SName) %>%  -->
<!--   mutate(prop = n/sum(n)) %>%  -->
<!--   select(-3) %>%  -->
<!--   pivot_wider(1:3, names_from = word, values_from = prop, values_fill = 0)  -->

<!-- top_10 <- contagem %>% arrange(desc(n)) %>% slice(1:10) %>% pull(word) -->

<!-- prop_por_song %>%  -->
<!--   select(1, top_10) %>%  -->
<!--   mutate(var1 = sum(time:love), -->
<!--          var2 = sum(hard:night)) %>%  -->
<!--   e_chart(var1) %>%  -->
<!--   e_scatter(var2, symbol_size = 5, legend = F) %>%  -->
<!--   e_tooltip(trigger = "axis",  -->
<!--             formatter = e_tooltip_pointer_formatter("currency"), -->
<!--             axisPointer = list(type = "cross"), -->
<!--             backgroundColor = "rgb(255,255,255,0.8)",  -->
<!--             borderColor = '#333', borderWidth = 1, -->
<!--             textStyle = list(color = '#333')) -->
<!-- ``` -->


# Sentiment Analysis

```{r message=FALSE, warning=FALSE}
sentiments <- get_sentiments("nrc")

songs_e_sent <- songs %>% select(c(2, 4, 5)) %>% 
  unnest_tokens(word, letras) %>%
  anti_join(stop_words) %>% inner_join(sentiments) %>% 
  mutate(sentiment = str_to_sentence(sentiment))

songs_e_sent %>% 
  group_by(sentiment) %>% 
  count() %>% ungroup() %>% 
  arrange(n) %>% 
  e_charts(sentiment) %>% 
  e_bar(n, name = "Frequency", legend = F) %>% 
  e_flip_coords() %>% 
  e_tooltip(backgroundColor = "rgba(255,255,255,0.8)", borderColor = '#333', borderWidth = 1,
            textStyle = list(color = '#333')) %>% 
  e_labels(position = "right")
```

Now you can choose a song

```{r message = F}
sent_por_mus <- songs_e_sent %>% 
  group_by(SName, album_name, sentiment) %>% count() %>% 
  ungroup() %>% group_by(SName) %>% 
  mutate(prop = round(n/sum(n), 3)) %>% 
  ungroup()
```


## {.tabset .tabset-fade .tabset-pills}

```{r message = F}
# prop_sent_by_song <- function(input_album){
#   
#   df <- songs_e_albuns %>% 
#   filter(Album == input_album) %>% 
#   group_by(SName, sentiment) %>% count() %>% 
#   ungroup() %>% group_by(SName) %>% 
#   mutate(prop = round(n/sum(n), 2)) %>% 
#     ungroup()
#   
#   principal_sentimento <- df %>% 
#     filter(prop == max(prop)) %>% 
#     pull(sentiment)
#   
#   df %>% group_by(SName) %>% 
#   e_charts(sentiment, timeline = TRUE) %>% 
#   e_pie(prop, legend = F, radius = c("45%", "70%")) %>% 
#   #e_grid(left = "30%")  %>% 
#   e_timeline_opts(
#         top = 'middle',
#         right = '100%',
#         orient = "vertical",
#         label = list(position = 'left'),
#         controlStyle = list(showPlayBtn = F, itemSize = 0, itemGap = 110),
#         lineStyle = list(show = F),
#         itemStyle = list(color = 'rgba(128, 128, 128, 0.3)')
#     ) %>%
#   e_tooltip("item", 
#             backgroundColor = "rgba(255,255,255,0.8)", 
#             borderColor = '#333', borderWidth = 1,
#             textStyle = list(color = '#333')) %>% 
#     e_text_g(right = 385, top = 250, z = -999,
#              style = list(text = principal_sentimento, 
#                           width = 450, opacity = .6)
#              ) 
#   
# }

prop_sent_by_song <- function(input_album){
  
  ordem_sent <- c("Positive", "Joy", "Trust", "Surprise", "Anticipation",
                  "Disgust", "Fear", "Anger", "Sadness", "Negative")
  
  df <- sent_por_mus %>% 
    mutate(sentiment = factor(sentiment, levels = ordem_sent)) %>% 
    filter(album_name == input_album) %>% 
    # group_by(SName, sentiment) %>% count() %>% 
    # ungroup() %>% 
    group_by(SName) %>% 
    mutate(n_sentiments = n()) %>% 
    arrange(desc(n_sentiments), sentiment)
  
  df %>% 
    group_by(sentiment) %>% 
    e_charts(SName) %>% 
    e_bar(prop, stack = "grp") %>%
    e_y_axis(max = 1) %>% 
    e_flip_coords() %>%
    e_grid(left = "20%") %>% 
    e_color(c("#12753F", "#4D976F", "#88BA9F", "#C3DCCF", "#EED8D8",
              "#DEB1B1", "#CD8B8B", "#BD6464", "#AC3D3D", "#9C1717")) %>% 
    e_tooltip(trigger = "axis", backgroundColor = "rgba(255,255,255,0.8)",
              borderColor = '#333', borderWidth = 1, 
              textStyle = list(color = '#333'))
  
}
```

### Is This It

```{r echo=FALSE}
prop_sent_by_song("Is This It")
```

 
### Room On Fire

```{r echo=FALSE}
prop_sent_by_song("Room On Fire")
```

### First Impressions of Earth

```{r echo=FALSE}
prop_sent_by_song("First Impressions Of Earth")
```

### Angles

```{r echo=FALSE}
prop_sent_by_song("Angles")
```

### Comedown Machine

```{r echo=FALSE}
prop_sent_by_song("Comedown Machine")
```

### Future Present Past

```{r echo=FALSE}
prop_sent_by_song("Future Present Past")
```

### The New Abnormal

```{r echo=FALSE}
prop_sent_by_song("The New Abnormal")
```

### Others

```{r echo=FALSE}
prop_sent_by_song("Others")
```
 
## {.tabset .tabset-fade .tabset-pills}

```{r}
gauge_trios <- function(sent){
  
  top_3 <- sent_por_mus %>% 
    mutate(SName = ifelse(SName == "Modern Girls & Old Fashioned Men", 
                          "Modern Girls & \n Old Fashioned Men",
                          SName)) %>% 
    filter(sentiment == sent) %>% 
    slice_max(prop, n = 3)
  
  g1 <- e_charts() %>% # O outro modelo é mais bonitinho
  e_gauge(as.numeric((top_3[1,5]*100) %>% round(1)), 
          paste0("\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n", top_3[1,1]),
          z = 1)

  g2 <- e_charts() %>% 
  e_gauge(as.numeric((top_3[2,5]*100) %>% round(1)), 
          paste0("\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n", top_3[2,1])) 

  g3 <- e_charts() %>% 
  e_gauge(as.numeric((top_3[3,5]*100) %>% round(1)), 
          paste0("\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n", top_3[3,1])) 

  e_arrange(g1, g2, g3, rows = 1, cols = 3)
  
}
```


### Anger

```{r echo=FALSE}
gauge_trios("Anger")
```


### Anticipation

```{r echo=FALSE}
gauge_trios("Anticipation")
```

### Disgust

```{r echo=FALSE}
gauge_trios("Disgust")
```


### Fear

```{r echo=FALSE}
gauge_trios("Fear")
```

### Joy

```{r echo=FALSE}
gauge_trios("Joy")
```

### Negative

```{r echo=FALSE}
gauge_trios("Negative") 
```

### Positive

```{r echo=FALSE}
gauge_trios("Positive")
```

### Sadness

```{r echo=FALSE}
gauge_trios("Sadness") 
```

### Surprise

```{r echo=FALSE}
gauge_trios("Surprise")
```

### Trust

```{r echo=FALSE}
gauge_trios("Trust")
```


<!-- ## The Afinn Tecniche -->

<!-- Other tecnique to analyse text -->

<!-- ```{r message = F} -->
<!-- afinn <- get_sentiments("afinn") -->

<!-- sent_num_por_mus <- songs %>% select(c(2,4)) %>%  -->
<!--   unnest_tokens(word, letras) %>% -->
<!--   anti_join(stop_words) %>% -->
<!--   group_by(word) %>%  -->
<!--   count() %>% ungroup() %>%  -->
<!--   inner_join(afinn) %>%  -->
<!--   filter(word != "yeah") -->
<!-- ``` -->

<!-- Ainda tenho que sumarisar o total de negatividade por música -->


<!-- ```{r message = F} -->
<!-- sent_num_por_mus %>%  -->
<!--   e_charts() %>%  -->
<!--   e_histogram(value) %>%  -->
<!--   e_tooltip(backgroundColor = "rgba(255,255,255,0.8)",  -->
<!--             borderColor = '#333', borderWidth = 1, -->
<!--             textStyle = list(color = '#333')) -->
<!-- ``` -->

<!-- ```{r message = F} -->
<!-- sent_num_por_mus %>%  -->
<!--   e_charts(value) %>%  -->
<!--   e_scatter(n, name = "Frequency") %>%  -->
<!--   e_tooltip(backgroundColor = "rgba(255,255,255,0.8)",  -->
<!--             borderColor = '#333', borderWidth = 1, -->
<!--             textStyle = list(color = '#333')) -->
<!-- ``` -->



<!-- # Term Frequency -->

<!-- ```{r message = F} -->
<!-- tf_idf <- songs %>% select(c(2, 4, 5)) %>%  -->
<!--   unnest_tokens(word, letras) %>% -->
<!--   anti_join(stop_words) %>%  -->
<!--   group_by(SName, album_name) %>%  -->
<!--   count(word) %>% ungroup() %>%  -->
<!--   bind_tf_idf(word, SName, n) -->

<!-- tf_idf %>%           -->
<!--   e_chart() %>%  -->
<!--   e_histogram(tf_idf) %>%  -->
<!--   e_tooltip(backgroundColor = "rgba(255,255,255,0.8)",  -->
<!--             borderColor = '#333', borderWidth = 1, -->
<!--             textStyle = list(color = '#333')) -->

<!-- tf_idf %>%          # O quanto isso faria sentido? -->
<!--   e_chart(tf) %>%  -->
<!--   e_scatter(idf) %>%  -->
<!--   e_tooltip(backgroundColor = "rgba(255,255,255,0.8)",  -->
<!--             borderColor = '#333', borderWidth = 1, -->
<!--             textStyle = list(color = '#333')) -->
<!-- ``` -->

<!-- ## {.tabset .tabset-fade .tabset-pills} -->

<!-- ```{r message = F} -->
<!-- tf_idf_by_song <- function(input_album){ -->

<!--   tf_idf %>% -->
<!--     filter(album_name == input_album) %>%  -->
<!--     slice_max(tf_idf, n = 10) %>%  -->
<!--     group_by(SName) %>%  -->
<!--     e_charts(word, timeline = T) %>%  -->
<!--     e_bar(tf_idf, legend = F, name = "Ajusted Frequency") %>% -->
<!--     e_grid(left = "30%") %>%  -->
<!--     e_timeline_opts(top = 'middle', -->
<!--                     right = '100%', -->
<!--                     orient = "vertical", -->
<!--                     label = list(position = 'left'), -->
<!--                     controlStyle = list(showPlayBtn = F, itemSize = 0, itemGap = 110), -->
<!--                     lineStyle = list(show = F), -->
<!--                     itemStyle = list(color = 'rgba(128, 128, 128, 0.3)')) %>%  -->
<!--     e_tooltip(backgroundColor = "rgba(255,255,255,0.8)",  -->
<!--               borderColor = '#333', borderWidth = 1, -->
<!--               textStyle = list(color = '#333')) %>%  -->
<!--     e_flip_coords() -->

<!-- } -->
<!-- ``` -->

<!-- ### Is This It -->

<!-- ```{r echo=FALSE} -->
<!-- tf_idf_by_song("Is This It") -->
<!-- ``` -->


<!-- ### Room On Fire -->

<!-- ```{r echo=FALSE} -->
<!-- tf_idf_by_song("Room On Fire") -->
<!-- ``` -->

<!-- ### First Impressions of Earth -->

<!-- ```{r echo=FALSE} -->
<!-- tf_idf_by_song("First Impressions Of Earth") -->
<!-- ``` -->

<!-- ### Angles -->

<!-- ```{r echo=FALSE} -->
<!-- tf_idf_by_song("Angles") -->
<!-- ``` -->

<!-- ### Comedown Machine -->

<!-- ```{r echo=FALSE} -->
<!-- tf_idf_by_song("Comedown Machine") -->
<!-- ``` -->

<!-- ### Future Present Past -->

<!-- ```{r echo=FALSE} -->
<!-- tf_idf_by_song("Future Present Past") -->
<!-- ``` -->

<!-- ### The New Abnormal -->

<!-- ```{r echo=FALSE} -->
<!-- tf_idf_by_song("The New Abnormal") -->
<!-- ``` -->

<!-- ### Others -->

<!-- ```{r echo=FALSE} -->
<!-- tf_idf_by_song("Others") -->
<!-- ``` -->

<!-- # Words Relationship -->

<!-- ```{r echo=FALSE, message = F} -->
<!-- duplas <- songs %>% select(c(2,4)) %>%  -->
<!--   unnest_tokens(bigram, letras, token = "ngrams", n = 2) %>% -->
<!--   separate(bigram, c("word1", "word2"), sep = " ") %>%  -->
<!--   filter(!word1 %in% stop_words$word, !word2 %in% stop_words$word) -->

<!-- sankey <- duplas %>% group_by(word1, word2) %>% count() %>% ungroup() -->

<!-- library(ggraph) -->
<!-- library(igraph) -->

<!-- bigram_graph <- sankey %>% -->
<!--   filter(n > 5) %>% -->
<!--   igraph::graph_from_data_frame() -->

<!-- a <- grid::arrow(type = "closed", length = unit(.15, "inches")) -->

<!-- ggraph(bigram_graph, layout = "fr") + -->
<!--   geom_edge_link(aes(edge_alpha = n), show.legend = FALSE, -->
<!--                  arrow = a, end_cap = circle(.07, 'inches')) + -->
<!--   geom_node_point(color = "lightblue", size = 5) + -->
<!--   geom_node_text(aes(label = name), vjust = 1, hjust = 1) + -->
<!--   theme_void() -->
<!-- ``` -->

# Dados Spotify {.tabset .tabset-fade .tabset-pills}

```{r}
boxplot_por_album <- function(var){
  
  # Ainda estressada com os labels do eixo x;
  # E as tooltips com Is This It em tudo??
  
  songs %>% 
    mutate(
      album_name = case_when(
        album_name == "First Impressions Of Earth" ~ "First\nImpressions\nOf Earth",
        album_name == "Comedown Machine" ~ "Comedown\nMachine",
        album_name == "Future Present Past" ~ "Future\nPresent\nPast",
        album_name == "The New Abnormal" ~ "The New\nAbnormal",
        T ~ album_name)
      ) %>% 
    pivot_wider(id_cols = SName, names_from = album_name, values_from = !!sym(var)) %>% 
    e_charts() %>% 
    e_boxplot(`Is This It`) %>% 
    e_boxplot(`Room On Fire`) %>% 
    e_boxplot(`First\nImpressions\nOf Earth`) %>% 
    e_boxplot(`Angles`) %>% 
    e_boxplot(`Comedown\nMachine`) %>% 
    e_boxplot(`Future\nPresent\nPast`) %>% 
    e_boxplot(`The New\nAbnormal`) %>% 
    e_boxplot(`Others`) %>%
    e_color("#AC3D3D") %>% 
    e_tooltip(backgroundColor = "rgb(255,255,255,0.8)", 
              borderColor = '#333', borderWidth = 1,
              textStyle = list(color = '#333')) %>% 
    e_x_axis(axisLabel = list(fontSize = 9)) # %>% 
    # e_y_axis(type ='category') %>% e_x_axis(type ='value')
  
}

top10var_por_album <- function(var){
  
  # Era para estar em outra ordem...
  
  renamed_songs <- songs %>% 
    mutate(
      across(6:14, ~round(., 2)),
      SName = case_when(
        SName == "I'll Try Anything Once (You Only Live Once Demo)" ~ "I'll Try Anything Once\n(You Only Live Once Demo)",
        SName == "Mercy Mercy Me (The Ecology)" ~ "Mercy Mercy Me\n(The Ecology)",
        SName == "Life Is Simple In The Moonlight" ~ "Life Is Simple\nIn The Moonlight", 
        T ~ SName)
      )
  
  g1 <- renamed_songs %>% 
    mutate() %>% 
    drop_na() %>%
    mutate(Var = !!sym(var)) %>% 
    slice_min(order_by = Var, n = 10) %>% 
    group_by(album_name) %>% 
    e_charts(SName) %>% 
    e_bar(Var, stack = "grp") %>% 
    e_flip_coords() %>% 
    e_labels(position = "right") %>% 
    e_grid(left = "40%") %>% 
    e_title("Valores Menores") %>% 
    e_legend(bottom = 0) %>% 
    e_tooltip(backgroundColor = "rgb(255,255,255,0.8)", 
              borderColor = '#333', borderWidth = 1,
              textStyle = list(color = '#333'))
  
  g2 <- renamed_songs %>% 
    drop_na() %>%
    mutate(Var = !!sym(var)) %>% 
    slice_max(order_by = Var, n = 10) %>% 
    group_by(album_name) %>% 
    e_charts(SName) %>% 
    e_bar(Var, stack = "grp") %>% 
    e_flip_coords() %>% 
    e_labels(position = "right") %>% 
    e_grid(left = "40%") %>% 
    e_title("Valores Maiores") %>%
    e_legend(bottom = 0) %>% 
    e_tooltip(backgroundColor = "rgb(255,255,255,0.8)", 
              borderColor = '#333', borderWidth = 1,
              textStyle = list(color = '#333'))
  
  e_arrange(g2, g1, rows = 1, cols = 2)
  
}

# top10var_por_album <- function(var){
#   
#   # Era para estar em outra ordem...
#   
#   songs %>% 
#     drop_na() %>%
#     mutate(Var = !!sym(var)) %>% 
#     arrange(Var) %>%
#     slice(1:10, (n() - 9):n()) %>% 
#     mutate(Top = rep(c("Menores", "Maiores"), each = 10),
#            n = c(1:10, 10:1) %>% as.factor()) %>% 
#     group_by(Top) %>% 
#     e_charts(n, timeline = T) %>% 
#     e_bar(Var, stack = "grp", name = SName) %>% 
#     e_flip_coords() %>% 
#     e_labels(position = "right") %>% 
#     e_y_axis(show = F) %>% 
#     e_tooltip(backgroundColor = "rgb(255,255,255,0.8)", 
#               borderColor = '#333', borderWidth = 1,
#               textStyle = list(color = '#333')) %>% 
#     e_timeline_opts(top = 'middle',
#                     right = '100%',
#                     orient = "vertical",
#                     label = list(position = 'left'),
#                     controlStyle = list(showPlayBtn = F, itemSize = 0, itemGap = 110),
#                     lineStyle = list(show = F),
#                     itemStyle = list(color = 'rgba(128, 128, 128, 0.3)'))
#   
# }
```

## Dançabilidade

```{r echo=FALSE}
boxplot_por_album("danceability")
top10var_por_album("danceability")
```

## Energia

```{r echo=FALSE}
boxplot_por_album("energy")
top10var_por_album("energy")
```

## Volume

```{r echo=FALSE}
boxplot_por_album("loudness")
top10var_por_album("loudness")
```

## Falado

```{r echo=FALSE}
boxplot_por_album("speechiness")
top10var_por_album("speechiness")
```

## Acústico

```{r echo=FALSE}
boxplot_por_album("acousticness")
top10var_por_album("acousticness")
```

## Instrumentalidade

```{r echo=FALSE}
boxplot_por_album("instrumentalness")
top10var_por_album("instrumentalness")
```

## Valência

```{r echo=FALSE}
boxplot_por_album("valence")
top10var_por_album("valence")
```

## Tempo 

```{r echo=FALSE}
boxplot_por_album("tempo")
top10var_por_album("tempo")
```

#

```{r}
shared_variavel1 <- songs %>% 
  pivot_longer(6:14, names_to = "var", values_to = "valor") %>% 
  select(6:7) %>% 
  SharedData$new()
shared_variavel2 <- songs %>% 
  pivot_longer(6:14, names_to = "var", values_to = "valor") %>% 
  select(6:7) %>% 
  SharedData$new()

# bscols(widths = c(3, NA),
# 
#   list(
#     filter_select("varx", "Eixo X", shared_variavel1, ~var,
#                   multiple = F),
#     filter_select("vary", "Eixo Y", shared_variavel2, ~var,
#                   multiple = F)
#   ),
# 
#   # ggplotly( # QUAL O PROBLEMA DO FILTRO??
#   # 
#   #   ggplot() +
#   #     geom_point(aes(x = shared_variavel1$data() %>% pull(valor),
#   #                    y = shared_variavel2$data() %>% pull(valor)))
#   # 
#   #   )
# 
# )


```

# Similaridades

Primeira tentativa com word2vec que eu não achei tão legal o resultado

```{r eval=FALSE, message=FALSE, include=FALSE}
set.seed(123456789)

token_songs <- songs %>% select(c(2,4)) %>%
  unnest_tokens(word, letras) %>%
  anti_join(stop_words)

model <-word2vec(x = token_songs$word, type ="cbow",dim = 15, iter = 20)
# o tipo também pode ser "skip-gram" 

embedding <- as.matrix(model)
embedding <- predict(model, c("beats"), type = "embedding") 

predict(model,c("beats"),type ="nearest",top_n =5) # 5 palavras mais similares

```

## Similaridade entre as letras

Cossine similarity (tried to keep the 10 more common words in each song) e testar no lugar da freq, o td-idft

O problema é que aqui a gente pega uma música e o sistema caça outras 5 iguais. Como faço para plotarrr

Mais infos: https://help.displayr.com/hc/en-us/articles/360003127476-How-to-Create-Customized-Tables-Using-the-DT-R-Package

```{r message = F}
freq_by_song <- songs %>% select(c(2,4)) %>% # provavelmente posso apagar
  unnest_tokens(word, letras) %>%
  anti_join(stop_words) %>%
  group_by(SName, word) %>%
  count() %>%
  ungroup() %>% group_by(SName) %>%
  #slice_max(order_by = n, n = 10) %>%  o cara usou muito mesmo
  pivot_wider(1:3, names_from = SName, values_from = n, values_fill = 0)

cosine_sim <- function(a, b) crossprod(a,b)/sqrt(crossprod(a)*crossprod(b))

calc_cos_sim <- function(name, freq = freq_by_song) {

  freq <- freq %>% select(-c(word))

  sapply(freq, list) %>%
    map(cosine_sim, freq %>% pull(name)) %>%
    unlist() %>%
    as.data.frame() %>%
    rename(Similarity = ".")

}

similaridades <- mapply(calc_cos_sim, freq_by_song %>% names() %>% .[-1]) %>%
  bind_cols() %>%
  pivot_longer(1:85, names_to = "Song1", values_to = "Similaridade") %>%
  mutate(Song1 = str_remove(Song1, ".Similarity"),
         Song2 = freq_by_song %>% names() %>% .[-1] %>% rep(each = 85),
         Similaridade = round(Similaridade, 3)) %>%
  filter(Similaridade != 1) %>%
  relocate(Similaridade, .after = last_col())

shared_similaridades <- SharedData$new(similaridades)

bscols(widths = c(3, NA),

  list(
    filter_select("song1", "Escolha a 1° Música",
                  shared_similaridades, ~Song1, multiple = F),
    filter_select("song2", "Escolha a 2° Música",
                  shared_similaridades, ~Song2, multiple = F)
  ),

  datatable(
    shared_similaridades, width = 500,
    class = "cell-border hover row-border",
    options = list(
      dom = 'tip',
      initComplete = JS(
        "function(settings, json) {",
        "$(this.api().table().header()).css({'color' : '#ffffff'});",
        "$(this.api().table().header()).css({'background-color': '#749eb3'});",
        "}"
        )
      )
  ) 

)
```

## Similaridade entre as variáveis

Diferente da outra função, por que as colunas não são as músicas;
Aqui já pode ser distância também;

```{r}
distancias <- get_dist(songs %>%
                         column_to_rownames("SName") %>%
                         select(5:13) %>% drop_na()) %>%
  as.matrix() %>%
  as.data.frame() %>%
  rownames_to_column("Song1") %>%
  pivot_longer(2:74, names_to = "Song2", values_to = "Distância") %>%
  filter(`Distância` != 0) %>%
  mutate(`Distância` = round(`Distância`, 2))

shared_distancias <- SharedData$new(distancias)

bscols(widths = c(3, NA),

  list(
    filter_select("song1", "Escolha a 1° Música",
                  shared_distancias, ~Song1, multiple = F),
    filter_select("song2", "Escolha a 2° Música",
                  shared_distancias, ~Song2, multiple = F)
  ),

  datatable(
    shared_distancias, width = 500,
    class = "cell-border hover row-border",
    options = list(
      dom = 'tip',
      initComplete = JS(
        "function(settings, json) {",
        "$(this.api().table().header()).css({'color' : '#ffffff'});",
        "$(this.api().table().header()).css({'background-color': '#749eb3'});",
        "}"
        )
      )
  ) 
  # %>% 
  #   formatStyle(
  #     'Distância',
  #     backgroundColor = '#B2B1B9'
  # )

)

```

O esperado era existir alguma correlação negativa

```{r}
similaridades %>%
  inner_join(distancias) %>%
  mutate(Dupla = paste(Song1, Song2, sep = " vs ")) %>%
  e_chart(Similaridade) %>%
  e_scatter(`Distância`,
            bind = Dupla # Define nomes para as observações
            ) %>%
  e_loess(`Distância` ~ Similaridade, showSymbol = FALSE) %>%
  e_lm(`Distância` ~ Similaridade, showSymbol = FALSE) %>%
  e_tooltip(formatter = htmlwidgets::JS("
      function(params){
        return('<strong>' + params.name +
               '</strong><br />Similaridade: ' + params.value[0] +
               '<br />Distância: ' + params.value[1])
      }
    "),
      backgroundColor = "rgb(255,255,255,0.8)",
      borderColor = '#333', borderWidth = 1,
      textStyle = list(color = '#333')
  )
```

```{r}
# 1/`Distância`, 

similaridades %>%
  inner_join(distancias) %>%
  mutate(Dupla = paste(Song1, Song2, sep = " vs "),
         `Distância` = (`Distância` - min(`Distância`))/(max(`Distância`) - min(`Distância`))) %>%
  e_chart(Similaridade) %>%
  e_scatter(`Distância`,
            bind = Dupla # Define nomes para as observações
            ) %>%
  e_loess(`Distância` ~ Similaridade, showSymbol = FALSE) %>%
  e_lm(`Distância` ~ Similaridade, showSymbol = FALSE) %>%
  e_tooltip(formatter = htmlwidgets::JS("
      function(params){
        return('<strong>' + params.name +
               '</strong><br />Similaridade: ' + params.value[0] +
               '<br />Distância: ' + params.value[1])
      }
    "),
      backgroundColor = "rgb(255,255,255,0.8)",
      borderColor = '#333', borderWidth = 1,
      textStyle = list(color = '#333')
  )
```

# Clusterização

```{r}
set.seed(123)

data_cluster <- songs %>% 
  drop_na() %>% 
  column_to_rownames("SName") %>% 
  select(5:13) %>% 
  scale()

fviz_nbclust(data_cluster, kmeans, method = "wss")
```

Com 5 clusters, um deles fica com apenas uma observação...
- Outra coisa: são 9 variáveis, para um pca decente, precisaria de pelo menos 90 músicas, e aqui eu tenho 73...

```{r}
k3 <- kmeans(data_cluster, centers = 3, nstart = 25)
pca <- prcomp(data_cluster)

# fviz_cluster(k3, geom = "point",  data = data_cluster) + ggtitle("k = 3")

cbind(data_cluster,
      agrupamento = fitted(k3, method = "class"),
      pca$x[,1:2]) %>%
    as.data.frame() %>%
    mutate(across(everything(), as.numeric),
           agrupamento = case_when(agrupamento == 2 ~ 0,
                                   agrupamento == 1 ~ 2,
                                   T ~ agrupamento),
           agrupamento = ifelse(agrupamento == 0, 1, agrupamento),
           agrupamento = paste("Grupo", agrupamento)) %>%
    arrange(agrupamento) %>%
    rownames_to_column("SName") %>%
    group_by(agrupamento) %>%
    e_charts(PC1) %>%
    e_scatter(PC2, bind = SName, symbol_size = 10) %>%
    e_axis_labels(x = "\n \n \n \n \n \n \n \n \n \n \n \n \n \n \n \n \n \n PCA1 (30.1%)",
                  y = "PCA2 (17.3%)                                                                                                    ") %>%
    e_color(c("#FE5D26", "#7EBC89", "#BAA5FF", "#D62246")) %>%
    e_tooltip(
        formatter = htmlwidgets::JS("
          function(params){return('<strong>' + params.name) +
                                  '</strong><br />x: ' + params.value[0] +
                                  '<br />y: ' + params.value[1]}"),
        backgroundColor = "rgba(255,255,255,0.8)", borderColor = '#333',
        borderWidth = 1, textStyle = list(color = '#333'))
```

Acredito que o PCA1 é muito influenciado por energia e tal e outro?

```{r}
agrupamentos <- songs %>%
  select(2, 6:14) %>%
  drop_na() %>%
  mutate(agrupamento = fitted(k3, method = "class"))

shared_agrupamentos <- SharedData$new(agrupamentos)

bscols(widths = c(3, NA),

  list(
    filter_select("agrupamento", "Escolha o Grupo",
                  shared_agrupamentos, ~agrupamento, multiple = F)
  ),

  datatable(shared_agrupamentos, width = 500,
            class = "cell-border hover row-border",
    options = list(
      dom = 'tip',
      scrollX = TRUE,
      initComplete = JS(
        "function(settings, json) {",
        "$(this.api().table().header()).css({'color' : '#ffffff'});",
        "$(this.api().table().header()).css({'background-color': '#749eb3'});",
        "}"
        )
      )
    )

)
```


## uns boxplot {.tabset .tabset-pills .tabcontent}

```{r}
boxplot_por_grupo <- function(var){

  # Ainda estressada com os labels do eixo x;
  # E as tooltips com Is This It em tudo??

  agrupamentos %>%
    mutate(agrupamento = paste("Grupo", agrupamento)) %>%
    pivot_wider(id_cols = SName, names_from = agrupamento, values_from = !!sym(var)) %>%
    e_charts() %>%
    e_boxplot(`Grupo 1`) %>%
    e_boxplot(`Grupo 2`) %>%
    e_boxplot(`Grupo 3`) %>%
    # e_boxplot(`Grupo 4`) %>%
    e_color("#AC3D3D") %>%
    e_tooltip(backgroundColor = "rgb(255,255,255,0.8)",
              borderColor = '#333', borderWidth = 1,
              textStyle = list(color = '#333'))

}
```


### Dançabilidade

```{r echo=FALSE}
boxplot_por_grupo("danceability")
```

### Energia

```{r echo=FALSE}
boxplot_por_grupo("energy")
```

### Volume

```{r echo=FALSE}
boxplot_por_grupo("loudness")
```

### Falado

```{r echo=FALSE}
boxplot_por_grupo("speechiness")
```

### Acústico

```{r echo=FALSE}
boxplot_por_grupo("acousticness")
```

### Instrumentalidade

```{r echo=FALSE}
boxplot_por_grupo("instrumentalness")
```

### Valência

```{r echo=FALSE}
boxplot_por_grupo("valence")
```

### Tempo

```{r echo=FALSE}
boxplot_por_grupo("tempo")
```

# 

<div class = "meunome">

<!-- <audio controls autoplay> -->
<!--   <source src = "Oasis.mp3" type = "audio/mpeg"/> -->
<!-- </audio> -->

<br/>

by Laura Alexandria de Oliveira

<ul class = "redes">

<li><a class="fas fa-user" href = "https://lauraalexandria.github.io/"></a></li>
<li><a class="fab fa-github" href = "https://github.com/lauraalexandria"></a></li>
<li><a class="fab fa-linkedin" href = "https://www.linkedin.com/in/laura-alexandria-de-oliveira/"></a></li>

</ul>
</div>

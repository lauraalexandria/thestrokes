---
output: 
  html_document: 
    df_print: default
    toc: yes
    toc_depth: 1
    toc_float:
      collapsed: no
      css: styles.css
---

<style>

@import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap');

body {
  text-align: justify}
  
#TOC {
  background: url("https://d1yjjnpx0p53s8.cloudfront.net/styles/logo-thumbnail/s3/022011/untitled-1_95.png?itok=i9qUrcs1");
  background-size: contain;
  padding-top: 250px !important;
  background-repeat: no-repeat;
  color: purple;
  border-color: #fffff}
  
.tocify {
  border: none;
}
  
.list-group-item.active, .list-group-item.active:focus, .list-group-item.active:hover {
    background-color: purple}
    
div.container {
  width: 100% 
}
    
div.bloco1 {
  text-align: justify;
  width : 250px;
  padding: 1em;
  background: rgba(143, 81, 249, 0.4);
  color: black;
  border-radius: 10px;
}

div.metade {
  width: 50%;
  float: left;
  text-align: justify;
  padding: 1em;
  background: rgba(143, 81, 249, 0.4);
  color: black;
  border: 5px solid white;
  border-radius: 10px;

</style>



```{r include=FALSE, message=F, warning=F}
library(tidyverse)
library(tidytext)
library(wordcloud2)
library(textdata) 
library(here)
library(echarts4r)
library(word2vec)

data("stop_words")  # Fixando as stopwords
stop_words <- stop_words %>% add_row(word = c("yeah", "gonna", "hey"))

source("WebScraping.R")
letras <- apply(songs[,3], 1, get_lyric)
songs <- songs %>% 
  mutate(letras = tolower(letras)) %>% 
  filter(!str_detect(SName, "[(]"))


e_common(theme = "london")
#opções de tema: london, tech-blue
```


# Introduction

I love The Strokes, and a WebScrap 82 songs of them

# Cloud Words

```{r echo=FALSE, message=F, warning=F}
contagem <- songs %>% select(c(2,4)) %>%
  unnest_tokens(word, letras) %>%
  anti_join(stop_words) %>%
  count(word)

#wordcloud2(contagem %>% filter(n > 5))

contagem %>%
  filter(n > 5) %>%
  e_charts() %>%
  e_cloud(word, n, shape = "circle") %>% 
  e_tooltip(backgroundColor = "rgb(255,255,255,0.8)", 
            borderColor = '#333', borderWidth = 1,
            textStyle = list(color = '#333'))

```


# Number of words by Song

```{r echo=FALSE, message=FALSE, warning=FALSE}
num_por_song <- songs %>% select(c(2,4)) %>% 
  unnest_tokens(word, letras) %>%
  anti_join(stop_words) %>%
  group_by(SName) %>% 
  count() %>% ungroup()

num_por_song  %>% 
  e_charts() %>%
  e_histogram(n) %>% 
  e_tooltip(trigger = "axis", backgroundColor = "rgb(255,255,255,0.8)", 
            borderColor = '#333', borderWidth = 1,
            textStyle = list(color = '#333'))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
menor <- num_por_song %>% slice_min(order_by = n, n = 1)
menor_mus <- menor %>% pull(SName)
menor_quant <- menor %>% pull(n)
maior <- num_por_song %>% slice_max(order_by = n, n = 1)
maior_mus <- maior %>% pull(SName)
maior_quant <- maior %>% pull(n)
```

  
<div class = "metade">
Agora é ver se eu consigo deixar um do lado do outro...
</div>
  
<div class = "metade">
Here, I use 3 subunits of size 4 (4x3=12). The last column is used for a plot. You can read more about the grid system [here](bootstrap grid system). I got this result showing the following code in my R Markdown document.
</div>


# Proportion of Word in each song - é aqui que poderia entrar um ANÁLISE FATORIAL

Foram usadas 1489 palavras diferentes em todas as músicas/ ainda tem que melhorar a tooltip aqui!

In this analysis I select the 10 words more frequent and I summed the proportion of them in each song forming 2 variables, the first one with the 5 firsts and the second one with the remaining. Now I see that doesn't make sense. 

```{r echo=FALSE, message=FALSE, warning=FALSE}
prop_por_song <- songs %>% select(c(2,4)) %>% 
  unnest_tokens(word, letras) %>%
  anti_join(stop_words) %>%
  group_by(SName, word) %>% 
  count() %>% 
  ungroup() %>% group_by(SName) %>% 
  mutate(prop = n/sum(n)) %>% 
  select(-3) %>% 
  pivot_wider(1:3, names_from = word, values_from = prop, values_fill = 0) 

top_10 <- contagem %>% arrange(desc(n)) %>% slice(1:10) %>% pull(word)

prop_por_song %>% 
  select(1, top_10) %>% 
  mutate(var1 = sum(time:love),
         var2 = sum(hard:night)) %>% 
  e_chart(var1) %>% 
  e_scatter(var2, symbol_size = 5, legend = F) %>% 
  e_tooltip(trigger = "axis", 
            formatter = e_tooltip_pointer_formatter("currency"),
            axisPointer = list(type = "cross"),
            backgroundColor = "rgb(255,255,255,0.8)", 
            borderColor = '#333', borderWidth = 1,
            textStyle = list(color = '#333'))
```


# Sentiment Analisys

```{r echo=FALSE, message=FALSE, warning=FALSE}
sentiments <- get_sentiments("nrc")

songs_e_sent <- songs %>% select(c(2,4)) %>% 
  unnest_tokens(word, letras) %>%
  anti_join(stop_words) %>% inner_join(sentiments) %>% 
  mutate(sentiment = str_to_sentence(sentiment))

songs_e_sent %>% 
  group_by(sentiment) %>% 
  count() %>% ungroup() %>% 
  e_charts(sentiment) %>% 
  e_bar(n, name = "Frequency", legend = F) %>% 
  e_flip_coords() %>% 
  e_tooltip(backgroundColor = "rgba(255,255,255,0.8)", borderColor = '#333', borderWidth = 1,
            textStyle = list(color = '#333')) %>% 
  e_labels(position = "right")
```

Now you can choose a song

```{r include=FALSE, message = F}
sent_por_mus <- songs_e_sent %>% 
  group_by(SName, sentiment) %>% count() %>% 
  ungroup() %>% group_by(SName) %>% 
  mutate(prop = n/sum(n)) %>% ungroup()
```


## {.tabset .tabset-fade .tabset-pills}

```{r include=FALSE, message = F}
songs_e_albuns <- songs_e_sent %>% 
  inner_join(albuns)

prop_sent_by_song <- function(input_album){
  
  songs_e_albuns %>% 
  filter(Album == input_album) %>% 
  group_by(SName, sentiment) %>% count() %>% 
  ungroup() %>% group_by(SName) %>% 
  mutate(prop = n/sum(n) %>% round(2)) %>% 
  e_charts(sentiment, timeline = TRUE) %>% 
  e_pie(prop, legend = F, radius = c("45%", "70%")) %>% 
    e_timeline_opts(
        top = 'middle',
        right = '100%',
        orient = "vertical",
        label = list(position = 'left'),
        controlStyle = list(showPlayBtn = F, itemSize = 0, itemGap = 110),
        lineStyle = list(show = F),
        itemStyle = list(color = 'rgba(128, 128, 128, 0.3)')
    ) %>%
  e_tooltip("item", 
            backgroundColor = "rgba(255,255,255,0.8)", 
            borderColor = '#333', borderWidth = 1,
            textStyle = list(color = '#333'))
  
}
```

### Is This It

```{r echo=FALSE}
prop_sent_by_song("Is This It")
```

 
### Room On Fire

```{r echo=FALSE}
prop_sent_by_song("Room On Fire")
```

### First Impressions of Earth

```{r echo=FALSE}
prop_sent_by_song("First Impressions of Earth")
```

### Angles

```{r echo=FALSE}
prop_sent_by_song("Angles")
```

### Comedown Machine

```{r echo=FALSE}
prop_sent_by_song("Comedown Machine")
```

### Future Present Past

```{r echo=FALSE}
prop_sent_by_song("Future Present Past [EP]")
```

### The New Abnormal

```{r echo=FALSE}
prop_sent_by_song("The New Abnormal")
```
 
## {.tabset .tabset-fade .tabset-pills}

```{r include=FALSE}
gauge_trios <- function(sent){
  
  top_3 <- sent_por_mus %>% 
  filter(sentiment == sent) %>% 
  slice_max(prop, n = 3)
  
  g1 <- e_charts() %>% # O outro modelo é mais bonitinho
  e_gauge(as.numeric((top_3[1,4]*100) %>% round(2)), 
          paste0("\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n", top_3[1,1]),
          z = 1)

  g2 <- e_charts() %>% 
  e_gauge(as.numeric((top_3[2,4]*100) %>% round(2)), 
          paste0("\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n", top_3[2,1])) 

  g3 <- e_charts() %>% 
  e_gauge(as.numeric((top_3[3,4]*100) %>% round(2)), 
          paste0("\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n", top_3[3,1])) 

  e_arrange(g1, g2, g3, rows = 1, cols = 3)
  
}
```


### Anger

```{r echo=FALSE}
gauge_trios("Anger")
```


### Anticipation

```{r echo=FALSE}
gauge_trios("Anticipation")
```

### Disgust

```{r echo=FALSE}
gauge_trios("Disgust")
```


### Fear

```{r echo=FALSE}
gauge_trios("Fear")
```

### Joy

```{r echo=FALSE}
gauge_trios("Joy")
```

### Negative

```{r echo=FALSE}
gauge_trios("Negative") 
```

### Positive

```{r echo=FALSE}
gauge_trios("Positive")
```

### Sadness

```{r echo=FALSE}
gauge_trios("Sadness") 
```

### Surprise

```{r echo=FALSE}
gauge_trios("Surprise")
```

### Trust

```{r echo=FALSE}
gauge_trios("Trust")
```

## The Afinn Tecniche

Other tecnique to analyse text

```{r echo=FALSE, message = F}
afinn <- get_sentiments("afinn")

sent_num_por_mus <- songs %>% select(c(2,4)) %>% 
  unnest_tokens(word, letras) %>%
  anti_join(stop_words) %>%
  group_by(word) %>% 
  count() %>% ungroup() %>% 
  inner_join(afinn) %>% 
  filter(word != "yeah")
```

Ainda tenho que sumarisar o total de negatividade por música


```{r echo=FALSE, message = F}
sent_num_por_mus %>% 
  e_charts() %>% 
  e_histogram(value) %>% 
  e_tooltip(backgroundColor = "rgba(255,255,255,0.8)", 
            borderColor = '#333', borderWidth = 1,
            textStyle = list(color = '#333'))
```

```{r echo=FALSE, message = F}
sent_num_por_mus %>% 
  e_charts(value) %>% 
  e_scatter(n, name = "Frequency") %>% 
  e_tooltip(backgroundColor = "rgba(255,255,255,0.8)", 
            borderColor = '#333', borderWidth = 1,
            textStyle = list(color = '#333'))
```



# Term Frequency

```{r echo=FALSE, message = F}
tf_idf <- songs %>% select(c(2,4)) %>% 
  unnest_tokens(word, letras) %>%
  anti_join(stop_words) %>% 
  group_by(SName) %>% 
  count(word) %>% ungroup() %>% 
  bind_tf_idf(word, SName, n)

tf_idf %>%          
  e_chart() %>% 
  e_histogram(tf_idf) %>% 
  e_tooltip(backgroundColor = "rgba(255,255,255,0.8)", 
            borderColor = '#333', borderWidth = 1,
            textStyle = list(color = '#333'))

tf_idf %>%          # O quanto isso faria sentido?
  e_chart(tf) %>% 
  e_scatter(idf) %>% 
  e_tooltip(backgroundColor = "rgba(255,255,255,0.8)", 
            borderColor = '#333', borderWidth = 1,
            textStyle = list(color = '#333'))
```

## {.tabset .tabset-fade .tabset-pills}

```{r include=FALSE, message = F}
tf_idf_by_song <- function(album){
  
  tf_idf %>%
    inner_join(albuns) %>% 
    filter(Album == album) %>% 
    slice_max(tf_idf, n = 10) %>% 
    group_by(SName) %>% 
    e_charts(word, timeline = T) %>% 
    e_bar(tf_idf, legend = F, name = "Ajusted Frequency")%>% 
    e_timeline_opts(top = 'middle',
                    right = '100%',
                    orient = "vertical",
                    label = list(position = 'left'),
                    controlStyle = list(showPlayBtn = F, itemSize = 0, itemGap = 110),
                    lineStyle = list(show = F),
                    itemStyle = list(color = 'rgba(128, 128, 128, 0.3)')) %>% 
    e_tooltip(backgroundColor = "rgba(255,255,255,0.8)", 
              borderColor = '#333', borderWidth = 1,
              textStyle = list(color = '#333')) %>% 
    e_flip_coords()

}
```

### Is This It

```{r echo=FALSE}
tf_idf_by_song("Is This It")
```

 
### Room On Fire

```{r echo=FALSE}
tf_idf_by_song("Room On Fire")
```

### First Impressions of Earth

```{r echo=FALSE}
tf_idf_by_song("First Impressions of Earth")
```

### Angles

```{r echo=FALSE}
tf_idf_by_song("Angles")
```

### Comedown Machine

```{r echo=FALSE}
tf_idf_by_song("Comedown Machine")
```

### Future Present Past

```{r echo=FALSE}
tf_idf_by_song("Future Present Past [EP]")
```

### The New Abnormal

```{r echo=FALSE}
tf_idf_by_song("The New Abnormal")
```

# Words Relationship

```{r echo=FALSE, message = F}
duplas <- songs %>% select(c(2,4)) %>% 
  unnest_tokens(bigram, letras, token = "ngrams", n = 2) %>%
  separate(bigram, c("word1", "word2"), sep = " ") %>% 
  filter(!word1 %in% stop_words$word, !word2 %in% stop_words$word)

sankey <- duplas %>% group_by(word1, word2) %>% count() %>% ungroup()

library(ggraph)
library(igraph)

bigram_graph <- sankey %>%
  filter(n > 5) %>%
  igraph::graph_from_data_frame()

a <- grid::arrow(type = "closed", length = unit(.15, "inches"))

ggraph(bigram_graph, layout = "fr") +
  geom_edge_link(aes(edge_alpha = n), show.legend = FALSE,
                 arrow = a, end_cap = circle(.07, 'inches')) +
  geom_node_point(color = "lightblue", size = 5) +
  geom_node_text(aes(label = name), vjust = 1, hjust = 1) +
  theme_void()
```

# Similarity

```{r echo=FALSE, message = F}
set.seed(123456789)

token_songs <- songs %>% select(c(2,4)) %>%
  unnest_tokens(word, letras) %>%
  anti_join(stop_words)

model <-word2vec(x = token_songs$word, type ="cbow",dim = 15, iter = 20)
# o tipo também pode ser "skip-gram" 

embedding <- as.matrix(model)
embedding <- predict(model, c("beats"), type = "embedding") 

predict(model,c("beats"),type ="nearest",top_n =5) # 5 palavras mais similares


```




